<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Rod's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/asciidoctor.css" rel="stylesheet">
    <link href="css/base.css" rel="stylesheet">
    <link href="css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
	
	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="">Rod's blog</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="feed.xml">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
	<div class="page-header">
		<h1>Blog</h1>
	</div>
  			<a href="blog/2016/12/using-the-gradle-teamcity-plugin-part2.html"><h1>Using the Gradle TeamCity plugin - Part 2</h1></a>
  			<p>30 December 2016</p>
            <p>Tags: 
                <a href="/tags/gradle.html">gradle</a>
            
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/build.html">build</a>
            
                <a href="/tags/plugin.html">plugin</a>
            </p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This post is the second of two on using the <a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a> and will cover
how to setup multiple TeamCity environments to test and debug a plugin.</p>
</div>
<div class="paragraph">
<p>First we will look at configuring environments, all the properties and tasks that are available and some tips
on setting up a project to develop a TeamCity plugin.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="environments">Environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Environments are configured in the <code>environments</code> configuration block under the <code>teamcity</code> configuration.
The environments configuration allows one or more TeamCity installations to be defined so that
the plugin being developed can be deployed and tested.</p>
</div>
<div class="sect2">
<h3 id="environment_properties">Environment properties</h3>
<div class="paragraph">
<p>An environment is given a name and each environment has the properties shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>teamcity {
    environments {
        name {
            version = '9.0'
            downloadUrl = `${baseDownloadUrl}/TeamCity-${version}.tar.gz`
            homeDir = `${baseHomeDir}/TeamCity-${version}`
            dataDir = `${baseDataDir}/${version}`
            javaHome = file('/path/to/java')
            serverOptions = '-Dteamcity.development.mode=true -Dteamcity.development.shadowCopyClasses=true'
            agentOptions = ''
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>version</code> property is the released version of TeamCity that is used by the environment. The property is used
as part of the URL to download TeamCity and as part of the directory where TeamCity is installed.</p>
</div>
<div class="paragraph">
<p>The <code>downloadUrl</code> property is the URL of a TeamCity release that is downloaded. The default is to download the
release archives from the JetBrains download site.</p>
</div>
<div class="paragraph">
<p>The <code>homeDir</code> property is the path to the TeamCity installation.</p>
</div>
<div class="paragraph">
<p>The <code>dataDir</code> property is the path to the <a href="https://confluence.jetbrains.com/display/TCD10/TeamCity+Data+Directory">TeamCity Data Directory</a> where the TeamCity
configuration is stored.</p>
</div>
<div class="paragraph">
<p>The <code>javaHome</code> property is the path to the version of Java to use to run the TeamCity Server and Build Agent. If the
property is not set the version of Java running Gradle is used.</p>
</div>
<div class="paragraph">
<p>The <code>serverOptions</code> property is a collection of options that are passed to the TeamCity Server at startup.</p>
</div>
<div class="paragraph">
<p>The <code>agentOptions</code> property is a collection of options that are passed to the TeamCity Build Agent at startup.</p>
</div>
<div class="paragraph">
<p>The example above shows all the properties with their default values, so the minimum required to create an environment
is a name, and in that case it would use TeamCity version 9.0. The minimum required for an environment using a
different version is to set the <code>version</code> and possibly the <code>javaHome</code> properties.</p>
</div>
<div class="listingblock">
<div class="title">Example environment using TeamCity 10.0.4 and Java 8</div>
<div class="content">
<pre>teamcity {
    environments {
        teamcity10 {
            version = '10.0.4'
            javaHome = file('/path/to/java8')
        }
    }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="shared_environment_properties">Shared environment properties</h3>
<div class="paragraph">
<p>The <code>downloadUrl</code>, <code>homeDir</code> and <code>dataDir</code> properties for all environments are based on shared environment properties
to allow installations and data directories to share a common parent directory. The shared properties and their
default values are shown in the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>teamcity {
    environments {
        downloadsDir = 'downloads'
        baseDownloadUrl = 'http://download.jetbrains.com/teamcity'
        baseDataDir = 'data'
        baseHomeDir = 'servers'
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>downloadsDir</code> property is the directory used to store the downloaded TeamCity archives. By default this
directory is under the project, but I would recommend changing this to store the files in another directory.</p>
</div>
<div class="paragraph">
<p>The <code>baseDownloadUrl</code> property is used to create the URL to download the TeamCity archive. The default is to use the
JetBrains download site, but it can be changed to use an alternative server, possibly a local enterprise server that
mirrors the JetBrains site.</p>
</div>
<div class="paragraph">
<p>The <code>baseHomeDir</code> property is the directory that the TeamCity release for each environment is installed. Instead of
the archive being unpacked to a 'TeamCity' directory the version is appended as shown earlier. I recommend changing
this to use a directory that can be shared by multiple projects.</p>
</div>
<div class="paragraph">
<p>The <code>baseDataDir</code> property is the base directory used to store all the TeamCity configuration files for each
environment. Each environment&#8217;s configuration files are stored in a sub-directory based on the TeamCity version, but
only the major and minor version numbers are used. I recommend keeping this directory within the project, any build
configurations will most likely be setup to test the TeamCity plugin and possibly not useful elsewhere.</p>
</div>
</div>
<div class="sect2">
<h3 id="environment_tasks">Environment tasks</h3>
<div class="paragraph">
<p>A set of tasks are created for each environment. These tasks support downloading and installing a TeamCity Server,
starting and stopping both the server and build agent. There are also tasks to deploy and undeploy the plugin to
each environment.</p>
</div>
<div class="paragraph">
<p>The following lists the task name and description:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>download<em>Name</em> - downloads the TeamCity archive</p>
</li>
<li>
<p>install<em>Name</em> - unpacks and installs TeamCity</p>
</li>
<li>
<p>deployPluginTo<em>Name</em> - deploy plugin to an environment</p>
</li>
<li>
<p>undeployPluginFrom<em>Name</em> -  the plugin from an environment</p>
</li>
<li>
<p>start<em>Name</em>Server - starts the server for an environment</p>
</li>
<li>
<p>stop<em>Name</em>Server - stops the server for an environment</p>
</li>
<li>
<p>start<em>Name</em>Agent - starts the default agent for an environment</p>
</li>
<li>
<p>stop<em>Name</em>Agent - stops the default agent for an environment</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The tasks for each environment are grouped by Gradle under 'TeamCity tasks'. The following image shows the tasks for
the 'teamcity10' environment in IntelliJ IDEA&#8217;s <a href="https://www.jetbrains.com/help/idea/2016.3/gradle-tool-window.html">Gradle Tool window</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/gradle-teamcity-tasks.png" alt="IDEA Gradle TeamCity Tasks">
</div>
</div>
</div>
<div class="sect2">
<h3 id="examples">Examples</h3>
<div class="paragraph">
<p>The following example shows configuring shared environment properties using Gradle extension properties. The extension
properties are themselves configured using Gradle properties. Gradle properties can be defined in a <code>gradle.properties</code>
file in the project root or in the <code>.gradle</code> directory of the user&#8217;s home directory. Additionally Gradle properties
can be set from the command line using the -P option.</p>
</div>
<div class="paragraph">
<p>The example below shows that the directory to download and store the TeamCity release archives can be overridden with
the Gradle <code>downloads.dir</code> property that is then used to set the shared environments property <code>downloadsDir</code>. Likewise
the <code>servers.dir</code> property is used to set <code>baseHomeDir</code> environments property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ext {
    downloadsDir = project.findProperty('downloads.dir') ?: "$rootDir/downloads"
    serversDir = project.findProperty('servers.dir') ?: "$rootDir/servers"
    java7Home = project.findProperty('java7.home') ?: '/opt/jdk1.7.0_80'
    java8Home = project.findProperty('java8.home') ?: '/opt/jdk1.8.0_92'
}

teamcity {
    ...

    environments {
        downloadsDir = project.downloadsDir
        baseHomeDir = project.serversDir
        baseDataDir = 'data'

        teamcity9 {
            version = '9.1.7'
            javaHome = file(java7Home)
        }

        teamcity10 {
            version = '10.0.4'
            javaHome = file(java8Home)
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>This next example shows using a Groovy closure to create a string with the Java debug options with a different port
for each Java process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def debugOptions = { port -> "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${port}" }

teamcity {
    environments {
        teamcity9 {
            version = '9.1.7'
            javaHome = file(java7Home)
            serverOptions debugOptions(5005)
            agentOptions debugOptions(5006)
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using_environment_tasks">Using environment tasks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this next section we use the tasks available in each environment to deploy the plugin, start and stop both the
TeamCity Server and Build Agent.</p>
</div>
<div class="sect2">
<h3 id="deploying_the_plugin">Deploying the plugin</h3>
<div class="paragraph">
<p>The following steps use the <a href="https://github.com/rodm/gradle-teamcity-plugin/tree/master/samples/agent-server-plugin">agent-server-plugin</a> from the samples directory. The plugin is a simple
example of a Build Feature plugin that has both agent-side and server-side components.</p>
</div>
<div class="paragraph">
<p>If the TeamCity Server for the environment is not already installed the following task can be executed to download and
install the TeamCity Server. This task can take several minutes to complete.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew installTeamcity10</pre>
</div>
</div>
<div class="paragraph">
<p>We can now start the TeamCity Server by executing the following task.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew startTeamcity10Server</pre>
</div>
</div>
<div class="paragraph">
<p>The output from the task shows that starting the server will also deploy the plugin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>:build UP-TO-DATE
:deployPluginToTeamcity10
:startTeamcity10Server

BUILD SUCCESSFUL</pre>
</div>
</div>
<div class="paragraph">
<p>The first time the server is started some setup is required, accepting the license, selecting the database and
creating an administration user.</p>
</div>
<div class="paragraph">
<p>To see the deployed plugin navigate to the <a href="http://localhost:8111/admin/admin.html?item=plugins">Plugins List</a> in the TeamCity Administration
page. The external plugins should show the plugin as shown in the following image</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/teamcity-plugins-list.png" alt="TeamCity Plugins List">
</div>
</div>
<div class="paragraph">
<p>The plugin can be deployed or re-deployed with or with-out the server running by executing the deploy task, as shown.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew deployPluginToTeamcity10</pre>
</div>
</div>
<div class="paragraph">
<p>Finally to start the TeamCity Build Agent the following task can be run.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew startTeamcity10Agent</pre>
</div>
</div>
<div class="paragraph">
<p>After the TeamCity Build Agent has finished its startup procedures it will appear in the
<a href="http://localhost:8111/agents.html">Agents</a> list.</p>
</div>
</div>
<div class="sect2">
<h3 id="making_a_change_to_a_web_resource_and_re_deploying_the_plugin">Making a change to a web resource and re-deploying the plugin</h3>
<div class="paragraph">
<p>We can make a change to a web resource file, for example changing the file
<code>src/main/resources/buildServerResources/example.jsp</code> and then re-deploy the plugin without re-starting the server.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew deployPluginToTeamcity10</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>...
:check UP-TO-DATE
:build
:deployPluginToTeamcity10

BUILD SUCCESSFUL

Total time: 7.467 secs</pre>
</div>
</div>
<div class="paragraph">
<p>Refreshing the <a href="http://localhost:8111/example.html">example page</a> should show the change.</p>
</div>
<div class="paragraph">
<p>It takes quite a few seconds for Gradle to configure and execute the tasks required to re-package and
re-deploy the plugin. Gradle supports a continuous option that keeps Gradle running and monitoring the project
for any changes. We can run the deploy task with the continuous option.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew --continuous deployPluginToTeamcity10</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Continuous build is an incubating feature.
...
:build UP-TO-DATE
:deployPluginToTeamcity10 UP-TO-DATE

BUILD SUCCESSFUL

Total time: 6.836 secs

Waiting for changes to input files of tasks... (ctrl-d to exit)</pre>
</div>
</div>
<div class="paragraph">
<p>Running the task with the continuous option takes about the same amount of time as the previous deploy but when the
resource file is changed again, as shown below, it is much quicker to re-deploy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Waiting for changes to input files of tasks... (ctrl-d to exit)
modified: .../agent-server-plugin/src/main/resources/buildServerResources/example.jsp
Change detected, executing build...

...
:check UP-TO-DATE
:build
:deployPluginToTeamcity10

BUILD SUCCESSFUL

Total time: 1.648 secs

Waiting for changes to input files of tasks... (ctrl-d to exit)</pre>
</div>
</div>
<div class="paragraph">
<p>To run the build continuously from within IDEA requires editing a Run/Debug Configuration and providing the
'--continuous' option to a configuration the executes a 'deploy' task, as shown in the following image:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/gradle-run-settings.png" alt="IDEA Gradle Run Configuration">
</div>
</div>
</div>
<div class="sect2">
<h3 id="making_a_change_to_a_class">Making a change to a class</h3>
<div class="paragraph">
<p>We can make a change to a class but there are some restrictions. The TeamCity documentation,
<a href="https://confluence.jetbrains.com/display/TCD10/Development+Environment">Development Environment</a>, covers what can and can&#8217;t be done when changing a class.
To summarise, using a debug connection, only method bodies can be changed and updated using the JVM&#8217;s HotSwap feature.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debugging_the_plugin">Debugging the plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will go through the steps to setup both the TeamCity Server and Build Agent in debug mode
and connect a remote debugger to them using IntelliJ IDEA.</p>
</div>
<div class="paragraph">
<p>To debug the TeamCity Server and Build Agent requires enabling the debug options for each Java process. The following
example shows and environment with debug options for both the server and agent. Note each uses a different port, this
is required if both are to be debugged at the same time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    environments {
        teamcity10 {
            version = '10.0.4'
            javaHome = file(java8Home)
            serverOptions '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005'
            agentOptions '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5006'
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a Remote Run/Debug Configuration for both the server and the agent, as shown below, the port for each should
match the configuration shown above.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/remote-debug-settings.png" alt="IDEA Remote Run/Debug Settings">
</div>
</div>
<div class="paragraph">
<p>We should then have two Remote Debug configurations as shown below.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/remote-debug-configuration.png" alt="IDEA Remote Run/Debug Configurations">
</div>
</div>
<div class="paragraph">
<p>Start both the server and agent using the Gradle tasks, 'startTeamcity10Server' and 'startTeamcity10Agent', either
from the command line or using the Gradle Tool Window in IDEA.</p>
</div>
<div class="paragraph">
<p>We will need a project and a build configuration to test debugging the plugin. Once the server is started create a
project and then a build configuration. The build configuration doesn&#8217;t require a VCS root or a build file,
a command line build step using an inline script will do.</p>
</div>
<div class="paragraph">
<p>Start the Remote debug connection for the server. Open the 'ExampleBuildFeature' class in the main project and
set a breakpoint in the 'describeParameters' method. Using the TeamCity UI edit the build configuration and
add the 'Example Build Feature', the remote debug connection should stop at the breakpoint in the plugin source.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/breakpoint-server-side.png" alt="Server-side plugin breakpoint">
</div>
</div>
<div class="paragraph">
<p>The same can be done for agent-side plugin code, start the Remote debug connection for the agent. Open the
'ExampleBuildFeature' class in the agent sub-project and set a breakpoint in the 'buildStarted' method.
Run the build configuration, the remote debug connection for the agent should stop at the breakpoint in the
agent-side plugin source.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/breakpoint-agent-side.png" alt="Agent-side plugin breakpoint">
</div>
</div>
<div class="paragraph">
<p>Be aware that the Agent debug connection can become disconnected if the agent preforms an upgrade. This can happen
if the agent-side code is changed and the plugin re-deployed.</p>
</div>
<div class="paragraph">
<p>This post has hopefully provided some help on testing and debugging TeamCity plugins using the
<a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>.</p>
</div>
</div>
</div></p>
  			<a href="blog/2016/11/using-the-gradle-teamcity-plugin-part1.html"><h1>Using the Gradle TeamCity plugin - Part 1</h1></a>
  			<p>30 November 2016</p>
            <p>Tags: 
                <a href="/tags/gradle.html">gradle</a>
            
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/build.html">build</a>
            
                <a href="/tags/plugin.html">plugin</a>
            </p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://rodm.github.io/blog/2016/10/teamcity-plugin-development-with-gradle.html">previous post</a> provided a very brief introduction to using the
<a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>.
This is the first post of two on using the plugin and will expand on the plugin&#8217;s configuration properties and tasks,
introduce agent-side plugin and tools support and a few tips on using the plugin. The second post will cover how to
setup multiple TeamCity environments to test and debug a plugin.</p>
</div>
<div class="paragraph">
<p>The Gradle TeamCity plugin actually consists of 3 plugins and typically each is applied to a separate Gradle project
in a multi-project setup to build and package the corresponding component of a TeamCity plugin.</p>
</div>
<div class="paragraph">
<p>The server-side plugin, <code>com.github.rodm.teamcity-server</code> adds tasks and dependencies to a Gradle project to build a
server-side plugin archive. This plugin is required to produced the final plugin archive to be deployed to a TeamCity server.</p>
</div>
<div class="paragraph">
<p>The agent-side plugin, <code>com.github.rodm.teamcity-agent</code> adds tasks and dependencies to a Gradle project to build an
agent-side plugin archive.</p>
</div>
<div class="paragraph">
<p>The third plugin is the common plugin, <code>com.github.rodm.teamcity-common</code>, this plugin only adds a dependency to a
Gradle project to support creating a shared library for use by both the agent-side and server-side components.</p>
</div>
<div class="paragraph">
<p>We can configure the version of the API to be used by the plugins by setting the <code>version</code> property in the <code>teamcity</code>
configuration. By default it&#8217;s set to '9.0', it can be set to any release or snapshot version of TeamCity but I
would recommend setting the version using only the major and minor numbers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    version = '9.1'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can support changing the version at build time by using a Gradle property. Using a Gradle property to change the
API version to build against makes it easy to discover any incompatible API changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">ext {
    teamcityVersion = findProperty('teamcity.version') ?: '9.1'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the above configuration, building the plugin against a newer version of the API can be run by providing an
override to the <code>teamcity.version</code> property at the command line.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew -Pteamcity.version=10.0 clean build</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common_plugin">Common plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first plugin of the three is the common plugin. This plugin only adds the <code>common-api</code> dependency to a Gradle
project. The output of the project, a jar file, can then be packaged with both the agent-side and server-side plugins.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">apply plugin: 'java'
apply plugin: 'com.github.rodm.teamcity-common'

teamcity {
    version = teamcityVersion
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above shows the <code>version</code> property being set with the value of the extension property <code>teamcityVersion</code>,
this expects the extension property value to be inherited from the root project.</p>
</div>
<div class="paragraph">
<p>By default the jar file will contain the project version as part of its name. For a jar file that will be packaged
into a plugin archive file it may not be necessary to keep the version, we can remove the version from the jar name
by setting the version property of the <code>jar</code> task to an empty string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">jar {
    version = ''
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="agent_plugin">Agent plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next plugin is the agent-side plugin, it adds the dependency <code>agent-api</code> to a project and the following
tasks:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>generateAgentDescriptor</code></p>
</li>
<li>
<p><code>processAgentDescriptor</code></p>
</li>
<li>
<p><code>agentPlugin</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>generateAgentDescriptor</code> task will use the descriptor defined in the Gradle build file and generate an agent-side
plugin descriptor file in the build directory. The task is disabled if the descriptor is defined to use an external
file.</p>
</div>
<div class="paragraph">
<p>The <code>processAgentDescriptor</code> task will use the descriptor file defined in the Gradle build file. It will copy the
descriptor file to the build directory and replace any token in the file with the value defined in the build file.</p>
</div>
<div class="paragraph">
<p>The <code>agentPlugin</code> task packages the agent-side jar, any third-party libraries and plugin descriptor into an agent-side
plugin archive, a zip file. The agent-side plugin archive is added to the <code>plugin</code> configuration so that it can be
used as a dependency by a project building the server-side plugin.</p>
</div>
<div class="paragraph">
<p>In addition to adding the above tasks the plugin extends the <code>jar</code> task to output warnings if the Spring Bean
descriptor file references any classes that are not included in the agent-side jar file.</p>
</div>
<div class="paragraph">
<p>The example below shows the minimum configuration required to create an agent-side plugin descriptor. More descriptor
properties supported by the plugin can be found in the <a href="https://github.com/rodm/gradle-teamcity-plugin#examples-1">examples</a> of the README file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    agent {
        descriptor {
            pluginDeployment {
                useSeparateClassloader = true
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can include a shared jar built against the <code>common-api</code> from another Gradle project by adding it as a dependency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">dependencies {
    compile project(':common')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the agent-side plugin archive name is a based on the name of the root Gradle project with '-agent' and
the project version appended. We can change this by setting the <code>baseName</code> and <code>version</code> properties of the <code>agentPlugin</code>
task.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">agentPlugin {
    baseName = 'pluginName'
    version = ''
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can include additional jars, native libraries and scripts in the plugin archive. The files to be included can be
defined in one or more <code>files</code> <a href="https://docs.gradle.org/current/javadoc/org/gradle/api/file/CopySpec.html">CopySpec</a> configuration blocks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    agent {
        files {
            into('lib') {
                from('path/to/additional/jars')
            }
        }
        files {
            into('bin') {
                from('path/to/scripts')
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="a_tool_plugin">A Tool plugin</h3>
<div class="paragraph">
<p>The agent-side plugin can also produce a tool plugin. A tool plugin can be used to repackage an existing tool for
deployment to TeamCity. The tool is made available to build configurations as a parameter, the parameter is the path
to where the tool is installed on each build agent.</p>
</div>
<div class="paragraph">
<p>A minimal Gradle project to build a tool plugin can apply the agent-side and server-side plugins and use Gradle&#8217;s
dependency management to download the tool to be repackaged.</p>
</div>
<div class="paragraph">
<p>The samples directory for the <a href="https://github.com/rodm/gradle-teamcity-plugin">Gradle TeamCity plugin</a> contains an example project,
agent-tool-plugin, that shows Apache Maven 3.3.3 being repackaged as a tool. The <a href="https://github.com/rodm/gradle-teamcity-plugin/blob/master/samples/agent-tool-plugin/build.gradle">build file</a>
shows how the Maven archive is downloaded as a dependency, added to the plugin archive using the <code>files</code>
<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/file/CopySpec.html">CopySpec</a> and how the <code>mvn</code> shell script is set to be executable.</p>
</div>
<div class="paragraph">
<p>Creating tool plugins is useful for deploying tools to all TeamCity build agents that are not available using
the native package manager on the build agent host.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server_plugin">Server plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The final plugin is the server-side plugin, it adds the dependency <code>server-api</code> to the project and the following
tasks:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>generateServerDescriptor</code></p>
</li>
<li>
<p><code>processServerDescriptor</code></p>
</li>
<li>
<p><code>serverPlugin</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>generateServerDescriptor</code> task will use the descriptor defined in the Gradle build file and generate an server-side
plugin descriptor file in the build directory. The task is disabled if the descriptor is defined to use an external
file.</p>
</div>
<div class="paragraph">
<p>The <code>processServerDescriptor</code> task will use the descriptor file defined in the Gradle build file. It will copy the
descriptor file to the build directory and replace any token in the file with the value defined in the build file.
An example is shown at the end of this post.</p>
</div>
<div class="paragraph">
<p>The <code>serverPlugin</code> task packages the server-side jar, any third-party libraries, the agent-side plugin archive and
plugin descriptor into a server-side plugin archive, a zip file.</p>
</div>
<div class="paragraph">
<p>A complete set of the descriptor properties supported by the server-side plugin can be found in the
<a href="https://github.com/rodm/gradle-teamcity-plugin#examples">examples</a> of the README file.</p>
</div>
<div class="paragraph">
<p>The server-side plugin, like the agent-side plugin, extends the <code>jar</code> to output warnings if the Spring Bean descriptor
file references classes that are not included in the server-side jar file.</p>
</div>
<div class="paragraph">
<p>To include a jar from another project that has been built against the <code>common-api</code> the same configuration
shown above for the agent-side plugin can be used.</p>
</div>
<div class="paragraph">
<p>To include the agent-side plugin archive, the output from a project building the agent-side plugin, can be added to
the <code>agent</code> configuration as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">dependencies {
    agent project(path: ':agent', configuration: 'plugin')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server-side plugin like the agent-side plugin can include additional files, jars or native libs, and scripts in
the archive using the <code>files</code> <a href="https://docs.gradle.org/current/javadoc/org/gradle/api/file/CopySpec.html">CopySpec</a> property. The example shown for the agent-side is the
same for the server-side.</p>
</div>
<div class="paragraph">
<p>The default name for the plugin archive is the name of the root Gradle project, this is typically defined in the
settings.gradle file, and the version property. We can change the name and remove the version from the archive name
by setting the following properties on the <code>serverPlugin</code> task.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">serverPlugin {
    baseName = 'pluginName'
    version = ''
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tokens to be replaced in the plugin descriptor XML file should follow Ant&#8217;s style for tokens, this means they
should start and end with the '@' character.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;teamcity-plugin xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:noNamespaceSchemaLocation="urn:schemas-jetbrains-com:teamcity-plugin-v1-xml"&gt;
    &lt;info&gt;
        &lt;name&gt;server-plugin&lt;/name&gt;
        &lt;display-name&gt;server-plugin&lt;/display-name&gt;
        &lt;version&gt;@VERSION@&lt;/version&gt;
        &lt;description&gt;TeamCity Example Server Plugin&lt;/description&gt;
        &lt;vendor&gt;
            &lt;name&gt;@VENDOR_NAME@&lt;/name&gt;
        &lt;/vendor&gt;
    &lt;/info&gt;
    &lt;deployment use-separate-classloader="true"/&gt;
&lt;/teamcity-plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To replace the tokens in the above file the server-side plugin can be configured, as shown below, to provide a map
of the tokens and values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    server {
        descriptor = file("${rootDir}/teamcity-plugin.xml")
        tokens VERSION: project.version, VENDOR_NAME: 'vendor'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This post has hopefully provided more detail and some tips on building TeamCity plugins using the
<a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>. The next post will show how to use the plugin to test and
debug a TeamCity plugin.</p>
</div>
</div>
</div></p>
  			<a href="blog/2016/10/teamcity-plugin-development-with-gradle.html"><h1>TeamCity Plugin Development with Gradle</h1></a>
  			<p>28 October 2016</p>
            <p>Tags: 
                <a href="/tags/gradle.html">gradle</a>
            
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/plugin.html">plugin</a>
            </p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This post follows the steps in <a href="https://confluence.jetbrains.com/display/TCD10/Getting+Started+with+Plugin+Development">Getting Started with Plugin Development</a>
but uses <a href="https://gradle.org">Gradle</a> as the build tool with the <a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#step_1_set_up_the_environment">Step 1 - Set up the environment</a></li>
<li><a href="#step_2_generate_a_gradle_project">Step 2 - Generate a Gradle project</a>
<ul class="sectlevel2">
<li><a href="#view_the_project_structure">View the project structure</a></li>
</ul>
</li>
<li><a href="#step_3_edit_the_plugin_descriptor">Step 3 - Edit the plugin descriptor</a></li>
<li><a href="#step_4_create_the_plugin_sources">Step 4 - Create the plugin sources</a>
<ul class="sectlevel2">
<li><a href="#a_create_the_plugin_web_resources">A. Create the plugin web-resources</a></li>
<li><a href="#b_create_the_controller_and_obtain_the_path_to_the_jsp">B. Create the controller and obtain the path to the JSP</a></li>
<li><a href="#c_update_the_spring_bean_definition">C. Update the Spring bean definition</a></li>
</ul>
</li>
<li><a href="#step_5_build_the_plugin_with_gradle">Step 5 - Build the plugin with Gradle</a></li>
<li><a href="#step_6_install_the_plugin_to_teamcity">Step 6 - Install the plugin to TeamCity</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_1_set_up_the_environment">Step 1 - Set up the environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To develop a plugin for TeamCity, first set up a plugin development environment.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and install <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Oracle Java</a>. Java 1.8 is required for TeamCity 10.</p>
</li>
<li>
<p>Download and install a Java IDE that has Gradle integration</p>
</li>
<li>
<p>Download and install <a href="https://gradle.org/gradle-download">Gradle</a>. Follow the <a href="https://docs.gradle.org/current/userguide/installation.html">Gradle installation instructions</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A TeamCity installation is not needed at this point and will be downloaded and installed later using a task provided
by the <a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_2_generate_a_gradle_project">Step 2 - Generate a Gradle project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unlike Maven, Gradle doesn&#8217;t have archetype support so the initial project structure will be created using Gradle&#8217;s
init task and the plugin files will be manually created.</p>
</div>
<div class="paragraph">
<p>Create a directory called demoPlugin, change into the directory and execute the following command to create
a Gradle project</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$GRADLE_HOME/bin/gradle init</pre>
</div>
</div>
<div class="paragraph">
<p>Note: On Windows use the <code>gradle.bat</code> command</p>
</div>
<div class="sect2">
<h3 id="view_the_project_structure">View the project structure</h3>
<div class="paragraph">
<p>After the command finishes the directory contains the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>build.gradle</code> file containing a commented-out sample Java project</p>
</li>
<li>
<p>the <code>settings.gradle</code> file</p>
</li>
<li>
<p>the <code>gradlew</code> file to run Gradle on Linux and OS X</p>
</li>
<li>
<p>the <code>gradlew.bat</code> file to run Gradle on Windows</p>
</li>
<li>
<p>the <code>gradle</code> directory contains the Gradle wrapper used to run Gradle</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Open the project in an IDE</p>
</div>
<div class="paragraph">
<p>Edit the <code>build.gradle</code> file and replace the contents with the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">plugins {
  id 'java'
  id 'com.github.rodm.teamcity-server' version '0.9.1'
}

group = 'com.demoDomain.teamcity.demoPlugin'
version = '1.0-SNAPSHOT'

teamcity {
    version = '10.0'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contents of the <code>settings.gradle</code> file should set the project name as shown</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">rootProject.name = 'demoPlugin'</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_3_edit_the_plugin_descriptor">Step 3 - Edit the plugin descriptor</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Gradle plugin supports defining the plugin descriptor in a separate file or in the build file. For this example
the descriptor will be defined in the <code>build.gradle</code> file. Add the following 'server' configuration block containing
the plugin descriptor to the build file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    version = '10.0'

    server {
        descriptor {
            name = project.name
            displayName = 'Demo Plugin'
            version = project.version
            vendorName = 'Demo Vendor'
            description = 'Demo plugin description'
            useSeparateClassloader = false
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the inline descriptor allows the descriptor to use property values generated during the build such as a
version number or a build timestamp.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_4_create_the_plugin_sources">Step 4 - Create the plugin sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create the following directories for the Java source and plugin resources</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>src/main/java</code></p>
</li>
<li>
<p><code>src/main/resources/META-INF</code></p>
</li>
<li>
<p><code>src/main/resources/buildServerResources</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="a_create_the_plugin_web_resources">A. Create the plugin web-resources</h3>
<div class="paragraph">
<p>In the <code>buildServerResources</code> directory create the <code>Hello.jsp</code> file. Enter the contents as shown in the
<a href="https://confluence.jetbrains.com/display/TCD10/Getting+Started+with+Plugin+Development#GettingStartedwithPluginDevelopment-A.Createthepluginweb-resources">TeamCity documentation</a></p>
</div>
</div>
<div class="sect2">
<h3 id="b_create_the_controller_and_obtain_the_path_to_the_jsp">B. Create the controller and obtain the path to the JSP</h3>
<div class="paragraph">
<p>In the <code>src/main/java</code> directory create the sub-directories <code>com/demoDomain/teamcity/demoPlugin</code> then create the
<code>AppServer.java</code> file. Enter the contents as shown in the
<a href="https://confluence.jetbrains.com/display/TCD10/Getting+Started+with+Plugin+Development#GettingStartedwithPluginDevelopment-B.CreatethecontrollerandobtainthepathtotheJSP">TeamCity documentation</a></p>
</div>
</div>
<div class="sect2">
<h3 id="c_update_the_spring_bean_definition">C. Update the Spring bean definition</h3>
<div class="paragraph">
<p>In the <code>src/main/resources/META-INF</code> directory create the file <code>build-server-plugin-demo-plugin.xml</code> and enter the
contents as shown in the
<a href="https://confluence.jetbrains.com/display/TCD10/Getting+Started+with+Plugin+Development#GettingStartedwithPluginDevelopment-C.UpdatetheSpringbeandefinition">TeamCity documentation</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_5_build_the_plugin_with_gradle">Step 5 - Build the plugin with Gradle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the root of the project execute the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew build</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>build/distributions</code> directory will contain the <code>demoPlugin-1.0-SNAPSHOT.zip</code> file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_6_install_the_plugin_to_teamcity">Step 6 - Install the plugin to TeamCity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To install and start a TeamCity instance edit the <code>build.gradle</code> file adding an 'environments' configuration block
as shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    server {
        descriptor {
            ...
        }

        environments {
            teamcity10 {
                version = '10.0.2'
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>./gradlew tasks</code> to see the new tasks available to download and install TeamCity, tasks to start and stop the
server and agent, and tasks to deploy and undeploy the plugin.</p>
</div>
<div class="paragraph">
<p>To download and install TeamCity for the environment, execute the following command, note this will take some time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew installTeamcity10</pre>
</div>
</div>
<div class="paragraph">
<p>To deploy the plugin and start the server execute the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew startTeamcity10Server</pre>
</div>
</div>
<div class="paragraph">
<p>The first time the TeamCity Server is started a database connection must be selected, the license agreement
accepted and an administrator account setup. Select 'Internal HSQLDB' for the database type.</p>
</div>
<div class="paragraph">
<p>The TeamCity Demo Plugin should appear in <a href="http://localhost:8111/admin/admin.html?item=plugins">Administration|Plugins List</a>.</p>
</div>
<div class="paragraph">
<p>The Hello World page is available via <a href="http://localhost:8111/demoPlugin.html" class="bare">http://localhost:8111/demoPlugin.html</a>.</p>
</div>
<div class="paragraph">
<p>Completed examples of the build files can be downloaded from the following links <a href="build.gradle">build.gradle</a> and
<a href="settings.gradle">settings.gradle</a></p>
</div>
</div>
</div></p>
	
	<hr />
	
	<p>Older posts are available in the <a href="archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; Rod MacKenzie 2016 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.5.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/prettify.js"></script>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-85716859-1', 'auto');
        ga('send', 'pageview');

    </script>

  </body>
</html>