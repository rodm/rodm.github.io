<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Rod's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Rod's blog">
    <meta name="author" content="Rod MacKenzie">
    <meta name="keywords" content="java, gradle, teamcity, development">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/asciidoctor.css" rel="stylesheet">
    <link href="css/base.css" rel="stylesheet">
    <link href="css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
	
	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="">Rod's blog</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="archive.html">Archive</a></li>
            <li><a href="feed.xml">Subscribe</a></li>
            <li><a href="about.html">About</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/rodm"><i class="fa fa-github"></i></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
	<div class="page-header">
		<h1>Blog</h1>
	</div>
  			<a href="blog/2017/04/teamcity-kotlin-dsl.html"><h1>More on TeamCity&apos;s Kotlin DSL</h1></a>
  			<p>12 April 2017</p>
            <p>Tags: 
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/configuration.html">configuration</a>
            
                <a href="/tags/kotlin.html">kotlin</a>
            
                <a href="/tags/dsl.html">dsl</a>
            
                <a href="/tags/gradle.html">gradle</a>
            </p>
            <p><div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This post is a continuation of my experiments using TeamCity&#8217;s Kotlin DSL that I started in my
<a href="https://rodm.github.com/blog/2017/03/teamcity-versioned-settings.html">previous post</a>.</p>
</div>
<div class="paragraph">
<p>In this post I cover adding multiple build configurations to a project and explore the different ways that can be
achieved, from simple copy and paste to using base build types and build templates.
Then I cover adding build features and build failure conditions to the build configurations.</p>
</div>
<div class="paragraph">
<p>The last few sections cover triggering a build when the settings change, the Maven plugin and a Gradle plugin. The
Maven plugin has a generate goal that provides some checking and reporting of any problems in the DSL.
The Gradle plugin is a plugin that I&#8217;ve developed that provides similar functionality to the Maven plugin.</p>
</div>
<div class="sect2">
<h3 id="documentation">Documentation</h3>
<div class="paragraph">
<p>When I started my experiments I hadn&#8217;t read the documentation only the series of
<a href="https://blog.jetbrains.com/teamcity/2016/11/kotlin-configuration-scripts-an-introduction/">posts</a> on the TeamCity blog.</p>
</div>
<div class="paragraph">
<p>The first page in the documentation <a href="https://confluence.jetbrains.com/display/TCD10/Storing+Project+Settings+in+Version+Control">Storing Project Settings in Version Control</a> covers
the setup of using versioned settings and synchronizing the settings with a VCS. It also covers the implications
of storing secure data such as passwords. The section on Displaying Changes covers triggering builds on settings
changes that I discuss later.</p>
</div>
<div class="paragraph">
<p>The <a href="https://confluence.jetbrains.com/display/TCD10/Kotlin+DSL">Kotlin DSL</a> page covers the advantages of using the Kotlin DSL, how to download the current
settings in a Kotlin format, working with the Kotlin DSL and setting up an IDE. It then covers making changes
to the settings and applying those changes to a TeamCity server.</p>
</div>
<div class="paragraph">
<p>The <a href="https://confluence.jetbrains.com/display/TCD10/Upgrading+DSL">Upgrading DSL</a> page covers the changes that have been made to the DSL between the 10.0 version
and the next release 2017.1. There are quite a number of changes, possibly a sign that the DSL is still being
developed.</p>
</div>
<div class="paragraph">
<p>The first two pages are useful for setting up a server to use versioned settings in the Kotlin format and
setting up an IDE to make changes but there is no DSL reference so not something that will be referred to a lot.</p>
</div>
<div class="paragraph">
<p>On the Kotlin DSL page there is a claim that it makes discovery of the available API options much simpler.
It is easy to find methods and fields but it is not easy to map a field to the equivalent field in the UI.</p>
</div>
<div class="paragraph">
<p>The documentation explains the purpose of the identifiers and the effect of changing a <code>uuid</code> on build configurations
and projects but it doesn&#8217;t explain why <code>extId</code> and <code>uuid</code> are required and can&#8217;t be derived from the name.
There is a section that recommends setting up unit tests for testing the DSL, but no example is provided, however
there is an example in the last post of the blog series mentioned earlier.</p>
</div>
<div class="paragraph">
<p>There is a recommendation to put the project settings in a separate VCS repository, I&#8217;ve used <a href="https://travis-ci.org/">Travis CI</a> and
<a href="https://www.appveyor.com/">AppVeyor</a> and like the idea of keeping the settings with the code. There are good reasons to use a separate
repository if passwords or other secure data maybe contained in the settings. One downside to this is having to tag
and branch the repositories together if you ever need to rebuild an older version.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kotlin_gradle_plugin">Kotlin Gradle plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When I was writing the <a href="https://rodm.github.com/blog/2017/03/teamcity-versioned-settings.html">previous post</a> I realised I was using the Java plugin, so I
changed the build to use the Kotlin plugin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">buildscript {
    repositories {
        mavenCentral()
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.0.3'
        classpath 'com.github.rodm:gradle-teamcity-plugin:0.11'
    }
}

apply plugin: 'kotlin'</code></pre>
</div>
</div>
<div class="paragraph">
<p>What this changed was that the <code>Project.kt</code> file would be compiled by the plugin so it provided some compile time
checking that the code was valid but the <code>settings.kts</code> file was not compiled. This was a small
improvement over the 'java' plugin that didn&#8217;t compile either of the files.</p>
</div>
<div class="paragraph">
<p>Using the Maven plugin does compile the <code>settings.kts</code> file but only if there is also a file with a <code>kt</code> extension
in the package.
There is a bit more to the <a href="#maven_plugin">Maven plugin</a> that I discuss later.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multiple_build_configurations">Multiple build configurations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before adding more build configurations I wanted to see if all the settings, project, build type and version control
could be stored in the <code>settings.kts</code> file rather than spread out over many files. This does work but it means
that neither the <code>java</code> plugin or the <code>kotlin</code> plugin will compile the file.</p>
</div>
<div class="paragraph">
<p>To fully build and test the <a href="https://github.com/rodm/gradle-teamcity-plugin">Gradle TeamCity plugin</a>, the project used to test the TeamCity Kotlin DSL, it is
built and tested using Java 7 and Java 8, there are also 2 build configurations that run functional tests again using
Java 7 and Java 8, then there is a build configuration to run the builds in the samples directory.
Finally there is a code quality build configuration that runs the <code>sonarqube</code> task.
The list of build configurations is as follows:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build - Java 7</p>
</li>
<li>
<p>Build - Java 8</p>
</li>
<li>
<p>Functional Test - Java 7</p>
</li>
<li>
<p>Functional Test - Java 8</p>
</li>
<li>
<p>Report - Code Quality</p>
</li>
<li>
<p>Samples Test - Java 7</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The differences between the build configurations can be achieved by setting the Gradle tasks and the Java home
parameters, except for the Code Quality build, this requires an additional property <code>gradle.opts</code> that is used
to provide the host URL for the SonarQube server.</p>
</div>
<div class="paragraph">
<p>The next few sections discuss the different ways I&#8217;ve tried using the Kotlin DSL to create the above
build configurations.</p>
</div>
<div class="sect2">
<h3 id="copy_paste_build_types">Copy &amp; Paste build types</h3>
<div class="paragraph">
<p>The first approach I took was just to copy and paste the code that creates a build type and modify it for each of the
build configurations listed above. Each build type required a new value for the <code>name</code>, <code>extId</code> and <code>uuid</code> properties.
For the different <code>uuid</code> values I copied the existing build&#8217;s value and changed the last character.</p>
</div>
<div class="paragraph">
<p>For builds running unit tests the <code>gradle.tasks</code> parameter was set to <code>clean build</code> for functional tests it was set
to <code>clean functionalTest</code>, for the samples test it was set to <code>clean samplesTest</code> and for the code quality build it
was set to <code>clean build sonarqube</code>.
For builds using Java 7 the <code>java.home</code> parameter was set to <code>%java7.home%</code> and for Java 8 it was set to <code>%java8.home%</code>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a link to the code
<a href="https://github.com/rodm/teamcity-settings/blob/d957834e4dc35ef061ce5f02b3d5c2a1bbb3510f/.teamcity/GradleTeamCityPlugin/settings.kts#L66-L95">settings.kts</a>
with the repeated block highlighted.</p>
</div>
</div>
<div class="sect2">
<h3 id="replace_duplicated_code_with_functions">Replace duplicated code with functions</h3>
<div class="paragraph">
<p>The next approach was to refactor the common code into functions. I created two functions <code>createBuildType</code> and
<code>configureBuildType</code>. The first function creates a build type with the <code>name</code>, <code>extId</code> and <code>uuid</code> properties set,
the second function uses Kotlin&#8217;s <code>apply</code> function to configure each built type with a VCS root, a Gradle build step,
a VCS trigger and the Gradle tasks and Java home parameters. This reduced the <code>settings.kts</code> file by about 70 lines.</p>
</div>
<div class="paragraph">
<p>The code can be seen at the following links, <a href="https://github.com/rodm/teamcity-settings/blob/cd18ac6099ee357528cb4736bf72dd00d4569dad/.teamcity/GradleTeamCityPlugin/settings.kts#L66-L68">build type</a>,
<a href="https://github.com/rodm/teamcity-settings/blob/cd18ac6099ee357528cb4736bf72dd00d4569dad/.teamcity/GradleTeamCityPlugin/settings.kts#L94-L100">createBuildType</a> and <a href="https://github.com/rodm/teamcity-settings/blob/cd18ac6099ee357528cb4736bf72dd00d4569dad/.teamcity/GradleTeamCityPlugin/settings.kts#L102-L130">configureBuildType</a></p>
</div>
</div>
<div class="sect2">
<h3 id="base_build_types">Base build types</h3>
<div class="paragraph">
<p>While writing the above code I noticed that the constructor for <code>BuiltType</code> takes an optional parameter, <code>base</code>, that
is another <code>BuildType</code>. The comment for the constructor indicates that if <code>base</code> is not null the settings are copied
from it to the new <code>BuildType</code>. So this provides another way of creating build configurations using shared code.</p>
</div>
<div class="paragraph">
<p>The code for the base type can be seen here, <a href="https://github.com/rodm/teamcity-settings/blob/d50402d4c1a7c717b34a9ff6adf3797a96409a1d/.teamcity/GradleTeamCityPlugin/settings.kts#L73-L119">base build type</a>, and the creation
of a build type using it can be seen here, <a href="https://github.com/rodm/teamcity-settings/blob/d50402d4c1a7c717b34a9ff6adf3797a96409a1d/.teamcity/GradleTeamCityPlugin/settings.kts#L121-L125">build type</a>.
Additionally parts of the configuration can be overridden within the lambda, as seen here,
<a href="https://github.com/rodm/teamcity-settings/blob/d50402d4c1a7c717b34a9ff6adf3797a96409a1d/.teamcity/GradleTeamCityPlugin/settings.kts#L148-L159">build type with overrides</a>,
the timeout is changed and the parameters have different values set.</p>
</div>
<div class="paragraph">
<p>I&#8217;ve not tried it but it should be possible to construct a base build type based on another base build type, possibly
reducing further the amount of code required to create multiple build configurations.</p>
</div>
<div class="paragraph">
<p>The code for base build types seems to create more readable code, some of the lines in the previous example were
too long.</p>
</div>
</div>
<div class="sect2">
<h3 id="build_template">Build template</h3>
<div class="paragraph">
<p>Using a build template is similar to the base <code>BuildType</code> discussed in the previous section, a <code>Template</code> is created
with the settings for a build configuration, then one or more <code>BuildType</code> s are created using the template. One
noticeable difference in the code, when exporting a template from TeamCity, is that there are more <code>id</code> s, build steps,
VCS triggers, and build features all have an <code>id</code>. This is to allow build configurations to override settings using
the <code>id</code> to refer to the configuration in the template. I&#8217;ve found that the <code>id</code> s can be removed, without causing a
problem, if they are not used to provide any additional configuration to a <code>BuildType</code>.</p>
</div>
<div class="paragraph">
<p>The following link shows the
<a href="https://github.com/rodm/teamcity-settings/blob/template/.teamcity/GradleTeamCityPlugin/settings.kts#L74-L127">build template</a>
and this link shows a
<a href="https://github.com/rodm/teamcity-settings/blob/template/.teamcity/GradleTeamCityPlugin/settings.kts#L129-L134">build type</a> using it</p>
</div>
<div class="paragraph">
<p>There is little to choose between using base build types and build templates when looking at the Kotlin DSL but
there is a difference with the XML files created by both. The base build type creates XML files that contain all the
configuration for the build type where as the build type using a template contains essentially only the differences
from the template, name, external id, uuid and any overrides.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="build_configuration">Build configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next sections will cover some of the parts of a build configuration or build template, to add build features,
failure conditions and a build trigger when the settings change.</p>
</div>
<div class="sect2">
<h3 id="build_features">Build features</h3>
<div class="paragraph">
<p>The first feature I added to the build configuration was to use the Performance Monitor during a build, this feature
is possibly one of the simplest to add, it has no configuration and the following code enables it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    feature {
        id = "perfmon"
        type = "perfmon"
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next feature I tried was more complex, a shared resource, it is configured at the project level and
for each build configuration that uses it. In my example a 'Resource with quota' called 'BuildLimit' is created
with a quota of '2', this will limit the number of concurrent builds using the resource to 2.</p>
</div>
<div class="paragraph">
<p>The following code shows how a shared resource is configured for a project.</p>
</div>
<div class="listingblock">
<div class="title">Project level feature configuration</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">project {
    features {
        feature {
            id = "PROJECT_EXT_2"
            type = "JetBrains.SharedResources"
            param("name", "BuildLimit")
            param("type", "quoted")
            param("quota", "2")
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code shows how a build configuration uses a shared resource</p>
</div>
<div class="listingblock">
<div class="title">Build type feature configuration</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    features {
        feature {
            id = "BUILD_EXT_2"
            type = "JetBrains.SharedResources"
            param("locks-param", "BuildLimit readLock")
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the configuration and usage of a resource is done using strings, there are no hints on what the names or values
could be, the only way is to configure a build and to export it. The XML Reporting plugin has the same problem
there are many reports supported and each has different configuration parameters that can only be found by configuring
a build using the UI and exporting it.</p>
</div>
<div class="paragraph">
<p>While <code>id</code> s are not necessary they are useful to override a configuration in a template. For example to disable
a feature the <code>enabled</code> property can be set to false with the <code>id</code> of the feature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    features {
        feature {
            id = "BUILD_EXT_2"
            enabled = false
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A more convenient method is available, the function <code>disableSettings</code> can be called with a variable list of ids
of the features to be disabled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    features {
        disableSettings("perfmon", "BUILD_EXT_2")
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>While not a build a feature I noticed that re-ordering build steps requires creating an ArrayList with the ids
of the build steps in the order that they are to be executed. There is no equivalent method to <code>disableSettings</code>
for the build steps order, so the API is inconsistent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    steps {
        ....
        stepsOrder = arrayListOf("RUNNER_2", "RUNNER_1", "RUNNER_3")
    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="failure_conditions">Failure conditions</h3>
<div class="paragraph">
<p>The only failure condition setting I typically make on a build configuration is to set a build timeout, and in this
example I set it to 10 minutes.
I&#8217;ve included all the properties that are available in the code below with their default values.
These were easy to discover within my IDE.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    failureConditions {
        executionTimeoutMin = 10
        nonZeroExitCode = true
        testFailure = true
        errorMessage = false
        javaCrash = true
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>While the above settings are easy to discover and set, additional failure conditions based on metrics or build log
messages are harder to configure using the API alone. Again setting up a build configuration with the failure
condition and then exporting the project from TeamCity in Kotlin format is the best option.</p>
</div>
<div class="paragraph">
<p>The example below shows a failure condition on a metric change, the enumerations for the various fields
looks ugly, it would be cleaner if the values could be specified without the enclosing classes.
It is also not easy to know which properties are required and which are optional.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    failOnMetricChange {
        metric = BuildFailureOnMetric.MetricType.ARTIFACT_SIZE
        units = BuildFailureOnMetric.MetricUnit.DEFAULT_UNIT
        comparison = BuildFailureOnMetric.MetricComparison.MORE
        compareTo = build {
            buildRule = lastPinned()
        }
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="triggering_a_build_when_settings_change">Triggering a build when settings change</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On the Versioned Settings page there is a <strong>Change Log</strong> view that shows the changes made to the settings, it only
shows changes made under the <code>.teamcity</code> directory. I wanted changes to the settings to trigger a build, it&#8217;s
possible a build failure is due to a configuration change.
Following the <a href="https://confluence.jetbrains.com/display/TCD10/Storing+Project+Settings+in+Version+Control#StoringProjectSettingsinVersionControl-DisplayingChanges">documentation</a>
I added the following to the VCS trigger.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    triggers {
         vcs {
            triggerRules = "+:root=Settings_root_id;:*"
         }
     }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This didn&#8217;t cause builds to trigger due to a settings change, so I changed the VCS root name to, <code>TeamcitySettings</code>
this also didn&#8217;t trigger any builds. After adding the VCS root to the build configuration and then reading the
documentation about trigger rules I eventually found that the following worked.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    triggers {
        vcs {
            triggerRules = """
                +:root=TeamcitySettings;:**
                +:root=GradleTeamcityPlugin:**
            """.trimIndent()
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The key was changing the file path wildcard pattern from '*' to '**', also both the VCS roots for the settings and
the project have to be included otherwise only changes to one VCS root will trigger a build.</p>
</div>
<div class="paragraph">
<p>I mentioned above that I added the settings VCS root to the build configuration, I had to revert that change,
the settings VCS root resulted in the project code being checked out then removed for the settings checkout.
So the build configuration has only the VCS root for the project and not the settings VCS root, this works despite
the reference in the trigger rules.
Although this causes TeamCity to show a warning in the UI about an un-attached VCS root.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/04/unattached-vcs-root.png" alt="Unattached VCS root">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="maven_plugin">Maven Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When I initially converted the Maven POM file to a Gradle equivalent I missed the Maven plugin,
<code>teamcity-configs-maven-plugin</code>.
The plugin only gets a brief mention in the
<a href="https://confluence.jetbrains.com/display/TCD10/Kotlin+DSL#KotlinDSL-ChangePasswordsafterSettingsGeneration">documentation</a>
about using it to scramble passwords for updating an existing configuration after a password change.</p>
</div>
<div class="paragraph">
<p>The plugin has two goals <code>generate</code> and <code>scramble</code>. The <code>generate</code> goal is interesting, executing this goal compiles
the Kotlin DSL settings and outputs the XML files used by TeamCity into the <code>target/generated-configs</code> directory. If
the DSL files fail to compile or contain an incorrect setting the XML files are not produced and a file
<code>dsl_exception.xml</code> is created listing the problems.</p>
</div>
<div class="paragraph">
<p>The example below shows what happens if a build type is created without a <code>uuid</code>.</p>
</div>
<div class="listingblock">
<div class="title">dsl_exception.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;exception message="DSL script execution failure"&gt;
  &lt;details&gt;
    &lt;info&gt;jetbrains.buildServer.configs.dsl.kotlin.KotlinRunner.run [106]&lt;/info&gt;
    &lt;info&gt;jetbrains.buildServer.configs.dsl.kotlin.KotlinRunner.run [85]&lt;/info&gt;
    &lt;info&gt;jetbrains.buildServer.configs.dsl.DslGeneratorProcess.generateProjects [79]&lt;/info&gt;
    &lt;info&gt;jetbrains.buildServer.configs.dsl.DslGeneratorProcess.main [41]&lt;/info&gt;
  &lt;/details&gt;
  &lt;errors&gt;
    &lt;error type="validation" source="" message="Missing uuid in buildType 'GradleTeamcityPlugin_BuildJava8'" project="GradleTeamCityPlugin" /&gt;
  &lt;/errors&gt;
&lt;/exception&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the invalid configuration change is committed, TeamCity will show the problem on the project page as shown below.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/04/missing-uuid.png" alt="Missing uuid">
</div>
</div>
<div class="paragraph">
<p>Running a build with an invalid configuration change will use the previous valid settings but will show that the
build has a problem.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/04/build-problems.png" alt="Build problems">
</div>
</div>
<div class="paragraph">
<p>The plugin provides a useful tool to check the settings before committing but there are many cases where it doesn&#8217;t
report a problem. It is possible to use the same <code>uuid</code> for build configurations, there are no checks for build feature
parameters and it doesn&#8217;t catch the import problem I had in the previous post.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gradle_dsl_plugin">Gradle DSL Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Maven plugin, <code>teamcity-configs-maven-plugin</code>, appears to be a simple adapter that calls into the DSL generator
code that is used by TeamCity.
I decided to try creating a Gradle plugin that does a similar job and the result can be found in this project,
<a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-dsl">gradle-teamcity-dsl-plugin</a>.
The plugin provides a task <code>generateConfiguration</code> that compiles the settings DSL and outputs the XML files
into the <code>build/generated-configs</code> directory and sets up the <code>.teamcity</code> directory as a source set.
It is still a work-in-progress but is quite usable now as an alternative to the Maven plugin.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The documentation provides useful setup information but lacks a good DSL reference like the Gradle DSL reference.</p>
</div>
<div class="paragraph">
<p>Using the DSL to create projects and build configurations is very flexible as shown by the different approaches
I took to create multiple build configurations. I&#8217;m sure one or more of them could be used to setup multiple projects
and possibly hundreds of build configurations.</p>
</div>
<div class="paragraph">
<p>Due to the lack of a good DSL reference the development cycle for creating and editing settings will require using
the TeamCity UI to configure a project or build configuration and to then export it in Kotlin format.</p>
</div>
<div class="paragraph">
<p>I imagine that creating build configurations targeting different platforms, build tools or version control systems
will have some of the same problems I&#8217;ve encountered above and possibly others.</p>
</div>
<div class="paragraph">
<p>A comment in my previous post describes how the code completion menu offers too many options, this was due to
the approach I took of moving all the code into the <code>settings.kts</code> file. I&#8217;m guessing most of the DSL API is in scope
making it more difficult to choose a valid, in scope, method or field. I discovered this after introducing the
functions to create a build type and configure it, within the functions there was less API options.</p>
</div>
<div class="paragraph">
<p>Hopefully this post and the <a href="https://rodm.github.com/blog/2017/03/teamcity-versioned-settings.html">previous post</a> have provided some ideas on how to use
TeamCity&#8217;s Kotlin DSL.</p>
</div>
</div>
</div></p>
  			<a href="blog/2017/03/teamcity-versioned-settings.html"><h1>TeamCity Versioned Settings with Kotlin</h1></a>
  			<p>17 March 2017</p>
            <p>Tags: 
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/configuration.html">configuration</a>
            
                <a href="/tags/kotlin.html">kotlin</a>
            
                <a href="/tags/gradle.html">gradle</a>
            </p>
            <p><div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This post is about my experiments using TeamCity&#8217;s Kotlin DSL after reading the
<a href="https://blog.jetbrains.com/teamcity/2016/11/kotlin-configuration-scripts-an-introduction/">Kotlin Configuration Scripts</a> series of posts on the TeamCity blog.
What I wanted to know, is it possible to start a new server and import versioned settings to setup a project with
one or more build configurations.
I also wanted to try using Gradle to resolve the Kotlin DSL dependencies.
My preferred build tool is Gradle and if I add a TeamCity configuration to a project could it be done without
having to add a Maven POM file to the project.</p>
</div>
<div class="paragraph">
<p>All the code used in this post can be found in the following GitHub repository
<a href="https://github.com/rodm/teamcity-settings">teamcity-settings</a> under the <strong>basic</strong> branch.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="project_setup">Project Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The initial project setup I used was a Gradle build file using the <a href="https://github.com/rodm/gradle-teamcity-plugin">Gradle TeamCity plugin</a>
with an environment configured to use TeamCity 10, this was used for starting and stopping the TeamCity Server and
Build Agent.</p>
</div>
<div class="paragraph">
<p>After starting the server I created a simple project in TeamCity with no VCS root or build configuration, this was
to get the minimum amount of code as a starting point.
The project settings were downloaded by selecting the <strong>Download settings in Kotlin format</strong> under the Actions drop down
when editing the project.</p>
</div>
<div class="paragraph">
<p>The settings are saved in a file called <code>projectSettings.zip</code>, unpacking this archive gives us the files shown below.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/03/initial-configuration-files.png" alt="Contents of projectSettings.zip">
</div>
</div>
<div class="sect2">
<h3 id="configuring_the_maven_repository_and_dependencies">Configuring the Maven Repository and Dependencies</h3>
<div class="paragraph">
<p>After unpacking the <code>projectSettings.zip</code> file, the Gradle build file needs to be updated with the dependencies that
will be used to provide type checking and code completion when editing the Kotlin DSL files.
The Maven POM file contains 2 repository configurations one for the JetBrains Maven repository and one for the TeamCity
server the settings were downloaded from.
Only the TeamCity server repository is added, the JetBrains Maven repository and MavenCentral are added by
the <a href="https://github.com/rodm/gradle-teamcity-plugin">Gradle TeamCity plugin</a>.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">repositories {
    maven {
        url 'http://localhost:8111/app/dsl-plugins-repository'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Maven POM file contains dependencies to the Kotlin standard library <code>kotlin-stdlib</code>, the Kotlin DSL library
<code>configs-dsl-kotlin</code> and to a Kotlin DSL plugins POM file <code>configs-dsl-kotlin-plugins</code>.
The Kotlin DSL plugin POM file contains dependencies to 20 Kotlin DSL plugin dependencies, Gradle doesn&#8217;t support
resolving dependencies from a POM type so each dependency was added to the build file. You can see the list of
dependencies <a href="https://github.com/rodm/teamcity-settings/blob/basic/build.gradle#L19-L44">here</a>.</p>
</div>
<div class="paragraph">
<p>Providing the DSL plugins from the TeamCity server means that the server must be started for either Maven or Gradle to
resolve the dependencies. I don&#8217;t know why these dependencies are provided by the TeamCity server and not available
from the JetBrains Maven repository but what I have discovered is that the dependencies are generated when the
server is started and removed when the server is shutdown.
They can be found in the TeamCity <code>temp</code> directory in a sub-directory with a name starting with <code>dslPlugins</code>. In that
directory there are sub-directories for each of the <code>configs-dsl-kotlin</code> dependencies and in each directory there
are 2 files <code>generated-dsl.jar</code> and <code>sources.jar</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure_the_main_java_source_set">Configure the main Java Source Set</h3>
<div class="paragraph">
<p>The next change to enable Gradle to parse the Kotlin DSL code is to apply the <code>java</code> plugin and configure the
<code>main</code> source set to locate the source in the <code>.teamcity</code> directory.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">sourceSets {
    main {
        java {
            srcDirs = ['.teamcity']
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This really just configures my IDE with the <code>configs-dsl-kotlin</code> dependencies in order to parse the code and
provide highlighting and code completion.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring_teamcity">Configuring TeamCity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project contains the minimum amount of code to setup a project in TeamCity and the next step is to import the
settings into TeamCity.</p>
</div>
<div class="paragraph">
<p>To import the settings from the <a href="https://github.com/rodm/teamcity-settings">teamcity-settings</a> project I setup a VCS root in the Root
project and set the <strong>Default branch</strong> field to <strong>refs/heads/basic</strong>.</p>
</div>
<div class="paragraph">
<p>Using the project I created earlier to generate the initial Kotlin DSL code I selected the <strong>Versioned Settings</strong> page
and selected the option <strong>Synchronization enabled</strong> with the sub-option <strong>use settings from VCS</strong>.</p>
</div>
<div class="paragraph">
<p>Enabling Versioned Settings Synchronization</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/03/versioned-settings-synchronization.png" alt="Versioned Settings Enabled">
</div>
</div>
<div class="paragraph">
<p>Clicking the Apply button TeamCity shows a warning dialog about scrambled passwords being committed to the
version control system, this can be ignored, the project configuration doesn&#8217;t contain any passwords. Clicking on
the OK button TeamCity then shows the <strong>Existing Project Settings Detected</strong> dialog.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/03/versioned-settings-existing-settings-detected.png" alt="Settings Detected">
</div>
</div>
<div class="paragraph">
<p>After selecting the <strong>Import settings from VCS</strong> option TeamCity takes a moment to import the settings and configure
the project.</p>
</div>
<div class="paragraph">
<p>My first attempt resulted in the <strong>Versioned Settings</strong> being disabled, with the option <strong>Use settings from parent project</strong>
being selected.</p>
</div>
<div class="paragraph">
<p>Disabled Version Settings</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/03/versioned-settings-disabled.png" alt="Version Settings Disabled">
</div>
</div>
<div class="paragraph">
<p>This should be expected, I didn&#8217;t provide the versioned settings configuration in the <code>Project.kt</code> file.
After defining a VCS root for the <a href="https://github.com/rodm/teamcity-settings">teamcity-settings</a> project and adding a <code>versionedSettings</code>
configuration block, shown below, repeating the steps above resulted in the project being configured to use the version
controlled settings.</p>
</div>
<div class="listingblock">
<div class="title">Project.kt</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    vcsRoot(GitVcsRoot({
        uuid = "723408f3-cc0c-42da-b348-dedd4bc030ef"
        extId = "TeamcitySettings"
        name = "teamcity-settings"
        url = "https://github.com/rodm/teamcity-settings"
        branch = "refs/heads/basic"
    }))

    features {
        versionedSettings {
            id = "PROJECT_EXT_1"
            mode = VersionedSettings.Mode.ENABLED
            buildSettingsMode = VersionedSettings.BuildSettingsMode.PREFER_SETTINGS_FROM_VCS
            rootExtId = "TeamcitySettings"
            showChanges = true
            settingsFormat = VersionedSettings.Format.KOTLIN
        }
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting_up_a_build">Setting up a Build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point the TeamCity project is using the configuration defined in the VCS repository, so the next step was to
setup a build configuration to checkout and build the <a href="https://github.com/rodm/gradle-teamcity-plugin">Gradle TeamCity plugin</a> project.
This project is a Gradle plugin built using the Gradle wrapper, the only requirement is a Java installation.</p>
</div>
<div class="paragraph">
<p>The following code defines the VCS root to checkout the project, the build step to call Gradle, a configuration
parameter used to define the Gradle tasks to execute and a VCS trigger. By default TeamCity will generate the code
for a build configuration in a separate Kotlin file, I wanted to keep the number of Kotlin files to a minimum so
put the configuration in the <code>Project.kt</code> file.</p>
</div>
<div class="listingblock">
<div class="title">Project.kt</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    val buildType = BuildType({
        uuid = "b9b0cbf7-1665-4fe5-a24d-956280379ef0"
        extId = "GradleTeamcityPlugin_Build"
        name = "Build - Java 7"

        vcs {
            root(vcs)
        }

        steps {
            gradle {
                tasks = "%gradle.tasks%"
                useGradleWrapper = true
                gradleWrapperPath = ""
                enableStacktrace = true
            }
        }

        params {
            param("gradle.tasks", "clean build")
        }

        triggers {
            vcs {
            }
        }
    })</code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete file can be seen <a href="https://github.com/rodm/teamcity-settings/blob/basic/.teamcity/GradleTeamCityPlugin/Project.kt">here</a>.</p>
</div>
<div class="paragraph">
<p>After committing the changes, TeamCity updated the project with the build configuration. However the build configuration
was incomplete, the VCS trigger was missing.</p>
</div>
<div class="paragraph">
<p>Missing VCS Trigger</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/03/vcs-trigger-missing.png" alt="Missing VCS Trigger">
</div>
</div>
<div class="paragraph">
<p>The problem was a missing import, after adding the following import statement the build configuration was updated and
the VCS trigger appeared.</p>
</div>
<div class="listingblock">
<div class="title">Project.kt</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import jetbrains.buildServer.configs.kotlin.v10.triggers.vcs</code></pre>
</div>
</div>
<div class="paragraph">
<p>VCS Trigger</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/03/vcs-trigger-default-settings.png" alt="VCS Trigger">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration_parameters">Configuration Parameters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One last change I made was to make the version of Java used to run the build configurable by using a
parameter.
The <code>jdkHome</code> property was added to the Gradle build step and the parameter defined in the parameters block.</p>
</div>
<div class="listingblock">
<div class="title">Project.kt</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">        steps {
            gradle {
                tasks = "%gradle.tasks%"
                useGradleWrapper = true
                gradleWrapperPath = ""
                enableStacktrace = true
                jdkHome = "%java.home%"
            }
        }

        params {
            param("gradle.tasks", "clean build")
            param("java.home", "%java7.home%")
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Setting it to use another parameter <code>java7.home</code> meant that after TeamCity updated the project the build configuration
had no compatible build agents..</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/03/incompatible-agents.png" alt="Incompatible Agents">
</div>
</div>
<div class="paragraph">
<p>To fix this required editing the <code>buildAgent.properties</code> file and adding the <code>java7.home</code> parameter, after the Build
Agent re-started the build configuration was compatible again.
This highlights that it is useful to have the <strong>Show settings changes in builds</strong> option in <strong>Versioned Settings</strong> enabled
and to check the TeamCity server after configuration changes to ensure builds have not been left unable to run.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After experimenting for a few days there were some positives and negatives, here is what I liked about using
the Kotlin DSL.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A newly setup TeamCity server can be bootstrapped by importing one or more projects with build configurations
from settings stored in a VCS repository.</p>
</li>
<li>
<p>Committing configuration changes show in the <strong>Change Log</strong> for any affected build configuration, useful when a
build fails and determining if it is due to a configuration change.</p>
</li>
<li>
<p>Configuration changes are updated automatically by TeamCity.</p>
</li>
<li>
<p>The code for the project and build configuration is easy to read and understand.</p>
</li>
<li>
<p>It is possible to create a Gradle build file to support editing the Kotlin DSL files.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And the negatives:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The initial generated code with the project, vcs settings, and build configurations is spread across multiple
Kotlin files.</p>
</li>
<li>
<p>The configuration DSL exposes too much of the implementation language, Kotlin, with each configuration type
being declared using an object expression, an anonymous class, and each file containing a number of import
statements.</p>
</li>
<li>
<p>The reason for using Kotlin for the DSL was to provide static type checking of the configuration but, as shown
above with the missing VCS trigger, it doesn&#8217;t help if the imports are wrong and Kotlin uses another function.</p>
</li>
<li>
<p>For the IDE or build tool to resolve the <code>configs-dsl-kotlin</code> dependencies requires a running TeamCity server.</p>
</li>
<li>
<p>When editing a configuration block I was expecting to see the code completion dialog show fewer functions to make
it easier to write, this didn&#8217;t appear to happen. For example, code completion shows the subproject function and many
others within the steps block.</p>
</li>
<li>
<p>Due to the above much of the example code shown above was created by editing a project using the TeamCity UI
then copying and pasting the required parts.</p>
</li>
<li>
<p>Each type in the configuration appears to require a <code>uuid</code>, a <code>extId</code>, and a <code>name</code> property, its not clear what the
significance of the <code>uuid</code> is.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configuring TeamCity using the Kotlin DSL works and is mostly readable but it has a number of problems in the steps
needed to create and maintain the configuration.
I would prefer the configuration to be in a single file, like <a href="https://travis-ci.org/">Travis CI</a> or <a href="https://www.appveyor.com/">AppVeyor</a>.
I would also like to see if the number of required properties can be reduced, are <code>uuid</code> and <code>extId</code> needed, or
could they be derived from the <code>name</code> property.
Can the dependencies for the Kotlin DSL plugins be published to the JetBrains Maven repository to avoid having
to start a TeamCity server.</p>
</div>
<div class="paragraph">
<p>I plan to continue experimenting, to create a project with multiple build configurations, to try build templates
and to try the <code>teamcity-configs</code> Maven plugin.</p>
</div>
</div>
</div></p>
  			<a href="blog/2017/02/installing-teamcity-using-the-war-file.html"><h1>Installing TeamCity using the war file</h1></a>
  			<p>28 February 2017</p>
            <p>Tags: 
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/installation.html">installation</a>
            
                <a href="/tags/configuration.html">configuration</a>
            </p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Most of this post was written a few years ago, like my previous post, but I never got around to finishing it. So after
tidying up some parts and finishing others, here it is.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The recommended installer to use for setting up a TeamCity installation is to use the TeamCity distribution bundled
with Tomcat. This post is about the setup of TeamCity using the war file that I&#8217;ve used since the first version of
TeamCity. The setup allows the configuration and supporting scripts to be committed to a version control system and
makes it easier to upgrade TeamCity, Tomcat and Java. The war file can be downloaded from the
<a href="https://www.jetbrains.com/teamcity/download/index.html">TeamCity download</a> page by selecting the JavaEE option.</p>
</div>
<div class="paragraph">
<p>The instructions for installing using the war file are here
<a href="https://confluence.jetbrains.com/display/TCD10/Installing+and+Configuring+the+TeamCity+Server#InstallingandConfiguringtheTeamCityServer-InstallingTeamCityintoExistingJ2EEContainer">Installing TeamCity into Existing J2EE Container</a>,
but I&#8217;m going to describe my approach that installs TeamCity on a Linux system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="directory_structure">Directory structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All the packages are installed into the <code>/opt</code> directory. Oracle&#8217;s version of Java is used as OpenJDK is not officially
supported by JetBrains but it may work, it is unpacked into the <code>/opt</code> directory. A directory for the TeamCity
application war file, configuration files, and shell scripts is created, <code>/opt/teamcity-server</code>. Tomcat is unpacked
into the <code>/opt</code> directory and the <code>conf</code> directory is copied to the <code>/opt/teamcity-server</code> directory. A teamcity user
and group are created using the <code>useradd</code> and <code>groupadd</code> commands and the <code>teamcity-server</code> directory has the owner
and group settings changed to use these ids.</p>
</div>
<div class="paragraph">
<p>The <code>/opt</code> directory looks like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>drwxr-xr-x  9 root     root     4096 May 19 22:34 apache-tomcat-7.0.54
drwxr-xr-x  8 uucp          143 4096 Jun 17 04:27 jdk1.7.0_65
drwxr-xr-x 10 teamcity teamcity 4096 Jan 28 18:08 teamcity-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contents of the directory, <code>/opt/teamcity-server</code>, after installing and adding scripts is as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>drwxr-xr-x 2 teamcity teamcity      4096 Jan 28 18:04 bin
drwxr-xr-x 3 teamcity teamcity      4096 Jan 28 18:04 conf
drwxr-xr-x 6 teamcity teamcity      4096 Jan 28 18:08 data
drwxr-xr-x 2 teamcity teamcity      4096 Jan 28 18:05 logs
drwxrwxr-x 4 teamcity teamcity      4096 Jan 28 18:08 temp
drwxrwxr-x 3 teamcity teamcity      4096 Jan 28 18:04 webapps
drwxrwxr-x 3 teamcity teamcity      4096 Jan 28 18:05 work
-rw-r--r-- 1 teamcity teamcity 434544596 Jan 28 18:04 TeamCity-8.0.6.war</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>bin</code> directory contains a script to start and stop TeamCity, <code>server.sh</code>. This script calls the <code>startup.sh</code> and
<code>shutdown.sh</code> scripts in the Tomcat installation directory and sets a number of environment variables and Java
properties to configure TeamCity and the JVM. The Tomcat environment variables <code>TOMCAT_HOME</code> and <code>TOMCAT_BASE</code> are
set to the Tomcat install directory and the TeamCity directory, they are explained in the <a href="https://tomcat.apache.org/tomcat-7.0-doc/RUNNING.txt">Tomcat</a>
documentation. The <code>TEAMCITY_DATA_PATH</code> variable is used to set the TeamCity BuildServer directory. An example of
the <code>server.sh</code> can be seen <a href="https://github.com/rodm/teamcity-vagrant/blob/409a7f071cb93c1d7f20f82b21b50716f7e97109/files/server/bin/server.sh">here</a>.</p>
</div>
<div class="paragraph">
<p>The data directory is the TeamCity <code>.BuildServer</code> directory that is normally created in the home directory of the user
that TeamCity runs under. The default is overridden by the <code>server.sh</code> script to use the <code>data</code> directory in
<code>/opt/teamcity-server</code>. Putting the TeamCity and Tomcat configuration along with the script to start and stop the server
under the <code>/opt/teamcity-server</code> directory allows the configuration to be stored in a version control system. The
following directories are excluded from version control <code>logs</code>, <code>temp</code>, <code>webapp</code> and <code>work</code>.
TeamCity 9 will support storing the configuration in version control but if you&#8217;re using an older version it&#8217;s
possible using this setup.</p>
</div>
<div class="paragraph">
<p>The <code>logs</code>, <code>temp</code> and <code>work</code> directories are empty directories and are used by Tomcat.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tomcat_configuration">Tomcat configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The file <code>server.xml</code> in the <code>conf</code> directory is modified, the port the server listens on is changed to the
default that TeamCity uses, 8111, the shutdown port is changed to 8115, and the redirectPort is changed to 8113.</p>
</div>
<div class="paragraph">
<p>On the connector for port 8111, the acceptCount is set to 100, the redirectPort to 8113, the useBodyEncodingForURI is
set to true, and maxThreads set to 200. On the connector for port 8113 (changed from 8443), the useBodyEncodingforURI
is set to true.</p>
</div>
<div class="paragraph">
<p>In the <code>conf/Catalina/localhost</code> directory a Tomcat context file is created, <code>teamcity.xml</code> that references the
TeamCity war file.</p>
</div>
<div class="listingblock">
<div class="title">teamcity.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Context docBase="${catalina.base}/TeamCity-8.0.6.war"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="database">Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The TeamCity documentation recommends not using the default HSQLDB database for a production setup. So I used MySQL,
it can be installed using the Linux package manager. A database is created for TeamCity to use, using the following SQL.
Here&#8217;s a link to TeamCity&#8217;s documentation on setting up on <a href="https://confluence.jetbrains.com/display/TCD10/Setting+up+an+External+Database#SettingupanExternalDatabase-MySQL">MySQL</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE DATABASE $TEAMCITY_DB_NAME DEFAULT CHARACTER SET utf8;

CREATE USER '$TEAMCITY_DB_USER'@'%' IDENTIFIED BY '$TEAMCITY_DB_PASS';
GRANT ALL ON $TEAMCITY_DB_NAME.* TO '$TEAMCITY_DB_USER'@'%';

DROP USER ''@'localhost';

DROP USER ''@'teamcity.localdomain';</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example uses environment variables to set the database name, user and password, an example setup script
can be seen <a href="https://github.com/rodm/teamcity-vagrant/blob/409a7f071cb93c1d7f20f82b21b50716f7e97109/scripts/setup-server.sh#L44">here</a>.</p>
</div>
<div class="paragraph">
<p>Before TeamCity added support for using the JDBC driver placed in the <code>&lt;TeamCity data directory&gt;/lib/jdbc</code> it was
possible to use another directory. Tomcat can be configured to add jars and classes to the classpath by modifying
the <code>catalina.properties</code> file. The MySQL JDBC driver can be put into the directory <code>shared/lib</code> and the property
<code>shared.loader</code> in <code>catalina.properties</code> can be changed to <code>shared/lib</code>. This avoids having to put the driver into the
<code>webapps/ROOT/WEB-INF/lib</code> directory.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="properties">Properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>server.sh</code> script used to start and stop TeamCity sets the following properties</p>
</div>
<div class="ulist">
<ul>
<li>
<p>java.net.preferIPv4Stack=true - Configures Java to prefer using IPv4 for network connections</p>
</li>
<li>
<p>java.rmi.server.hostname=$HOSTNAME - Allows remote JMX monitoring of the server, this must be the hostname for
remote access and not localhost</p>
</li>
<li>
<p>teamcity.data.path=$TEAMCITY_HOME/data - Overrides the default TeamCity data directory</p>
</li>
<li>
<p>teamcity_logs=$TEAMCITY_HOME/logs - Overrides the default directory for TeamCity logs</p>
</li>
<li>
<p>log4j.configuration=file:$TEAMCITY_HOME/conf/teamcity-server-log4j.xml</p>
</li>
<li>
<p>teamcity.diskSpaceWatcher.threshold=250000 - Reports free space on the server&#8217;s disk usage</p>
</li>
<li>
<p>teamcity.queue.mergeBuilds=true - Combines builds in the queue</p>
</li>
<li>
<p>modification.check.interval=360 - VCS check period</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The environment variable <code>TEAMCITY_HOME</code> is set to the <code>/opt/teamcity-server</code> directory.</p>
</div>
<div class="paragraph">
<p>The last three properties are TeamCity specific, I don&#8217;t remember where they came from, possibly from the support
forums, but they are possibly no longer used.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upgrading">Upgrading</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the main reasons for this setup was to make it easy to upgrade either Java, Tomcat or TeamCity.</p>
</div>
<div class="paragraph">
<p>To upgrade Java just requires unpacking a new version in the <code>/opt</code> directory and updating the <code>JAVA_HOME</code> environment
variable in the configuration file, <code>/etc/teamcity-server.conf</code>, that is used by the <code>server.sh</code> script.</p>
</div>
<div class="paragraph">
<p>Similarly upgrading Tomcat requires unpacking into the <code>/opt</code> directory and updating the <code>CATALINA_HOME</code> environment
variable in the file <code>/etc/teamcity-server.conf</code>. Using the <code>CATALINA_BASE</code> environment variable allows the Tomcat
installation to be separate from the configuration files, <code>conf/catalina.properties</code> and <code>conf/server.xml</code>, used by
the TeamCity webapp.</p>
</div>
<div class="paragraph">
<p>To upgrade TeamCity, the server is shutdown and the database is backed up. The contents of the <code>logs</code>, <code>temp</code>,
<code>webapps</code> and <code>work</code> directories can be moved or deleted, the <code>conf/Catalina/localhost/teamcity.xml</code> file is updated
to reference the new TeamCity war file, and the server is started.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The setup allows for easy upgrades of the various components, Java, Tomcat and TeamCity. All scripts and configuration
files for Tomcat and TeamCity are under one directory and can be committed to version control. It uses a little
less disk space than using the official installer, the default build agent and development package are omitted saving
about 35MB. While this isn&#8217;t much it does avoid the possibility of starting the default build agent which could then
use about 500MB or more of disk space. I think it is recommended to avoid running a build agent on the same machine
as the build server.</p>
</div>
<div class="paragraph">
<p>An example of the setup described above can be found in the <a href="https://github.com/rodm/teamcity-vagrant/blob/409a7f071cb93c1d7f20f82b21b50716f7e97109/scripts/setup-server.sh">setup-server.sh</a> script in
the <a href="https://github.com/rodm/teamcity-vagrant">teamcity-vagrant</a> project.
It uses Vagrant to setup and start the TeamCity server and up to three Build Agents.</p>
</div>
<div class="paragraph">
<p>This post doesn&#8217;t discuss the setup of TeamCity Build Agents, there is a <a href="https://github.com/rodm/teamcity-vagrant/blob/409a7f071cb93c1d7f20f82b21b50716f7e97109/scripts/setup-agent.sh">setup-agent.sh</a>
script in the <a href="https://github.com/rodm/teamcity-vagrant">teamcity-vagrant</a> project that downloads the buildAgent.zip file from the server
and configures the agent. The installation of Build Agents is probably a separate post, I&#8217;ve since created Build Agents
using <a href="https://www.packer.io/">Packer</a> and repackaged the buildAgent.zip as <code>RPM</code> and <code>deb</code> packages for Linux and a
<code>pkg</code> file for Mac, but I think most people will be looking at using Docker for running Build Agents.</p>
</div>
</div>
</div></p>
  			<a href="blog/2017/01/monitoring-teamcity-using-jmx.html"><h1>Monitoring TeamCity using JMX</h1></a>
  			<p>17 January 2017</p>
            <p>Tags: 
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/munin.html">munin</a>
            
                <a href="/tags/jmx.html">jmx</a>
            </p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Most of this post was written a few years ago but I never got around to finishing it. So after adding some images
showing the MBean attributes as viewed using Java VisualVM and updating the summary, here it is.</p>
</div>
<div class="paragraph">
<p>Where I used to work we had been using TeamCity for a number of years, and I developed a plugin to expose a
number of the server&#8217;s metrics via JMX so that we could track what it was doing over time.</p>
</div>
<div class="paragraph">
<p>To give an idea of the attributes that can be monitored by the plugin the following images show the MBean attributes
for a couple of the objects.
The first image shows the Build Server&#8217;s MBean attributes. Some of the attributes that will be discussed later
in this post are BuildQueueSize, RegisteredAgents, NumberOfRunningBuilds and CleanupDuration</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/01/teamcity-server-mbean-attributes.png" alt="TeamCity Server MBean attributes">
</div>
</div>
<div class="paragraph">
<p>The next image shows the MBean attributes for a Build Agent, specifically the Default Agent. If there were more build
agents, each would appear as a separate node under the Agent node.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/01/teamcity-agent-mbean-attributes.png" alt="TeamCity Agent MBean attributes">
</div>
</div>
<div class="paragraph">
<p>Additionally both have a BuildStatistics node with the following attributes, BuildsStarted, BuildsFinished,
BuildsInterrupted, SuccessfulBuilds, FailedBuilds and IgnoredBuilds.</p>
</div>
<div class="paragraph">
<p>What we started to track was, build agents connected and available to run builds, the number of builds running and
the number of builds in the build queue. Another important metric was server availability, TeamCity has a cleanup
process that runs each night and during the cleanup it&#8217;s unavailable. Having teams around the world means there is
only a small window for the clean up to happen, but we didn&#8217;t know how long it typically took.</p>
</div>
<div class="paragraph">
<p>The graph below is from the <a href="http://munin-monitoring.org/">Munin</a> monitoring tool which was configured to collect build agents
available, running builds and build queue size. These are the BuildServer MBean attributes RegisteredAgents,
NumberOfRunningBuilds and BuildQueueSize.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/01/teamcity-queue-day.png" alt="TeamCity Queue for a day">
</div>
</div>
<div class="paragraph">
<p>The blue line shows build agents running builds, and it shows that they a kept busy most of the time. The spike in
the build queue, the red line, above the 'Wed 00:00' label is when a number of maintenance builds that run on all the
agents are scheduled.</p>
</div>
<div class="paragraph">
<p>Another example shows the build activity for a week, most days are the same, the days labeled '01' and '02'
are the weekend.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/01/teamcity-queue-week.png" alt="TeamCity Queue for a week">
</div>
</div>
<div class="paragraph">
<p>Again the nightly maintenance tasks show up as spikes each day. One interesting problem is for day '02', the
build queue has a number of builds, agents are availble but the queue doesn&#8217;t decrease. One possible cause of
this is a build stuck on an agent and the queued builds are maintenance tasks for that agent. Another is a
resource monitor plugin that we use that can prevent builds from running if the resource isn&#8217;t available,
i.e. a database server.</p>
</div>
<div class="paragraph">
<p>The next graph shows the cleanup time for a month. It shows a variation in the amount of time that TeamCity
is unavailable, some days its only 15-20 minutes others its 90 minutes or more. There a few points on the
graph where 0 is recorded, this is due to the server being restarted, the JMX plugin only makes the cleanup
time available after a cleanup has occurred.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2017/01/teamcity-cleanup-month.png" alt="TeamCity clean-up for a month">
</div>
</div>
<div class="paragraph">
<p>The time taken is becoming a problem with us having teams around the world using the server, the following issue
is to address this and should hopefully make it into version 9,
<a href="http://youtrack.jetbrains.com/issue/TW-2527">TW-2527: Ability to have TeamCity server online 24/7</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integration_to_munin">Integration to Munin</h3>
<div class="paragraph">
<p>The JMX plugin only provides the current values when queried, to record the values over time and highlight trends the
<a href="http://munin-monitoring.org/">Munin</a> monitoring tool was configured to collect various values. Munin makes this
data available in graphs for the current day, week, month and year.</p>
</div>
<div class="paragraph">
<p>To integrate with Munin requires a plugin, the jmxquery plugin is available in the Munin plugin GitHub
repository under the contrib directory.  There are instructions on where to download the plugin and configure
Munin in this <a href="https://github.com/rodm/teamcity-jmx-plugin/blob/master/config/munin/README.md">README</a> file.</p>
</div>
</div>
<div class="sect2">
<h3 id="summary">Summary</h3>
<div class="paragraph">
<p>That was just a few examples of how <a href="https://en.wikipedia.org/wiki/Java_Management_Extensions">JMX</a> and <a href="http://munin-monitoring.org/">Munin</a> can be used to monitor a continuous
integration server.
The graphs produced by Munin allowed normal daily behaviour to be observed and allowed problems to be identified.
Using <a href="https://en.wikipedia.org/wiki/Java_Management_Extensions">JMX</a> and <a href="http://munin-monitoring.org/">Munin</a> was useful at the time but there maybe better options now for tracking
what your continuous integration server is doing.
Newer versions of TeamCity have the 'Usage Statistics' page but it may still be useful to collect values using JMX.</p>
</div>
<div class="paragraph">
<p>I had the intention of extending the plugin to expose more attributes using JMX but never got around to it.
The code for plugin is available on <a href="https://github.com/rodm/teamcity-jmx-plugin">GitHub</a> and the project page has instructions on how to
build it or alternatively it can be downloaded from the <a href="https://plugins.jetbrains.com/teamcity/plugin/9004-jmx-plugin">TeamCity Plugins</a> repository
or <a href="https://bintray.com/rodm/teamcity-plugins/teamcity-jmx-plugin">Bintray</a></p>
</div>
</div></p>
  			<a href="blog/2016/12/using-the-gradle-teamcity-plugin-part2.html"><h1>Using the Gradle TeamCity plugin - Part 2</h1></a>
  			<p>30 December 2016</p>
            <p>Tags: 
                <a href="/tags/gradle.html">gradle</a>
            
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/build.html">build</a>
            
                <a href="/tags/plugin.html">plugin</a>
            </p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This post is the second of two on using the <a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a> and will cover
how to setup multiple TeamCity environments to test and debug a plugin.</p>
</div>
<div class="paragraph">
<p>First we will look at configuring environments, all the properties and tasks that are available and some tips
on setting up a project to develop a TeamCity plugin.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="environments">Environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Environments are configured in the <code>environments</code> configuration block under the <code>teamcity</code> configuration.
The environments configuration allows one or more TeamCity installations to be defined so that
the plugin being developed can be deployed and tested.</p>
</div>
<div class="sect2">
<h3 id="environment_properties">Environment properties</h3>
<div class="paragraph">
<p>An environment is given a name and each environment has the properties shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    environments {
        name {
            version = '9.0'
            downloadUrl = `${baseDownloadUrl}/TeamCity-${version}.tar.gz`
            homeDir = `${baseHomeDir}/TeamCity-${version}`
            dataDir = `${baseDataDir}/${version}`
            javaHome = file('/path/to/java')
            serverOptions = '-Dteamcity.development.mode=true -Dteamcity.development.shadowCopyClasses=true'
            agentOptions = ''
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>version</code> property is the released version of TeamCity that is used by the environment. The property is used
as part of the URL to download TeamCity and as part of the directory where TeamCity is installed.</p>
</div>
<div class="paragraph">
<p>The <code>downloadUrl</code> property is the URL of a TeamCity release that is downloaded. The default is to download the
release archives from the JetBrains download site.</p>
</div>
<div class="paragraph">
<p>The <code>homeDir</code> property is the path to the TeamCity installation.</p>
</div>
<div class="paragraph">
<p>The <code>dataDir</code> property is the path to the <a href="https://confluence.jetbrains.com/display/TCD10/TeamCity+Data+Directory">TeamCity Data Directory</a> where the TeamCity
configuration is stored.</p>
</div>
<div class="paragraph">
<p>The <code>javaHome</code> property is the path to the version of Java to use to run the TeamCity Server and Build Agent. If the
property is not set the version of Java running Gradle is used.</p>
</div>
<div class="paragraph">
<p>The <code>serverOptions</code> property is a collection of options that are passed to the TeamCity Server at startup.</p>
</div>
<div class="paragraph">
<p>The <code>agentOptions</code> property is a collection of options that are passed to the TeamCity Build Agent at startup.</p>
</div>
<div class="paragraph">
<p>The example above shows all the properties with their default values, so the minimum required to create an environment
is a name, and in that case it would use TeamCity version 9.0. The minimum required for an environment using a
different version is to set the <code>version</code> and possibly the <code>javaHome</code> properties.</p>
</div>
<div class="listingblock">
<div class="title">Example environment using TeamCity 10.0.4 and Java 8</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    environments {
        teamcity10 {
            version = '10.0.4'
            javaHome = file('/path/to/java8')
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="shared_environment_properties">Shared environment properties</h3>
<div class="paragraph">
<p>The <code>downloadUrl</code>, <code>homeDir</code> and <code>dataDir</code> properties for all environments are based on shared environment properties
to allow installations and data directories to share a common parent directory. The shared properties and their
default values are shown in the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    environments {
        downloadsDir = 'downloads'
        baseDownloadUrl = 'http://download.jetbrains.com/teamcity'
        baseDataDir = 'data'
        baseHomeDir = 'servers'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>downloadsDir</code> property is the directory used to store the downloaded TeamCity archives. By default this
directory is under the project, but I would recommend changing this to store the files in another directory.</p>
</div>
<div class="paragraph">
<p>The <code>baseDownloadUrl</code> property is used to create the URL to download the TeamCity archive. The default is to use the
JetBrains download site, but it can be changed to use an alternative server, possibly a local enterprise server that
mirrors the JetBrains site.</p>
</div>
<div class="paragraph">
<p>The <code>baseHomeDir</code> property is the directory that the TeamCity release for each environment is installed. Instead of
the archive being unpacked to a 'TeamCity' directory the version is appended as shown earlier. I recommend changing
this to use a directory that can be shared by multiple projects.</p>
</div>
<div class="paragraph">
<p>The <code>baseDataDir</code> property is the base directory used to store all the TeamCity configuration files for each
environment. Each environment&#8217;s configuration files are stored in a sub-directory based on the TeamCity version, but
only the major and minor version numbers are used. I recommend keeping this directory within the project, any build
configurations will most likely be setup to test the TeamCity plugin and possibly not useful elsewhere.</p>
</div>
</div>
<div class="sect2">
<h3 id="environment_tasks">Environment tasks</h3>
<div class="paragraph">
<p>A set of tasks are created for each environment. These tasks support downloading and installing a TeamCity Server,
starting and stopping both the server and build agent. There are also tasks to deploy and undeploy the plugin to
each environment.</p>
</div>
<div class="paragraph">
<p>The following lists the task name and description:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>download<em>Name</em> - downloads the TeamCity archive</p>
</li>
<li>
<p>install<em>Name</em> - unpacks and installs TeamCity</p>
</li>
<li>
<p>deployPluginTo<em>Name</em> - deploy plugin to an environment</p>
</li>
<li>
<p>undeployPluginFrom<em>Name</em> -  the plugin from an environment</p>
</li>
<li>
<p>start<em>Name</em>Server - starts the server for an environment</p>
</li>
<li>
<p>stop<em>Name</em>Server - stops the server for an environment</p>
</li>
<li>
<p>start<em>Name</em>Agent - starts the default agent for an environment</p>
</li>
<li>
<p>stop<em>Name</em>Agent - stops the default agent for an environment</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The tasks for each environment are grouped by Gradle under 'TeamCity tasks'. The following image shows the tasks for
the 'teamcity10' environment in IntelliJ IDEA&#8217;s <a href="https://www.jetbrains.com/help/idea/2016.3/gradle-tool-window.html">Gradle Tool window</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/gradle-teamcity-tasks.png" alt="IDEA Gradle TeamCity Tasks">
</div>
</div>
</div>
<div class="sect2">
<h3 id="examples">Examples</h3>
<div class="paragraph">
<p>The following example shows configuring shared environment properties using Gradle extension properties. The extension
properties are themselves configured using Gradle properties. Gradle properties can be defined in a <code>gradle.properties</code>
file in the project root or in the <code>.gradle</code> directory of the user&#8217;s home directory. Additionally Gradle properties
can be set from the command line using the -P option.</p>
</div>
<div class="paragraph">
<p>The example below shows that the directory to download and store the TeamCity release archives can be overridden with
the Gradle <code>downloads.dir</code> property that is then used to set the shared environments property <code>downloadsDir</code>. Likewise
the <code>servers.dir</code> property is used to set <code>baseHomeDir</code> environments property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">ext {
    downloadsDir = project.findProperty('downloads.dir') ?: "$rootDir/downloads"
    serversDir = project.findProperty('servers.dir') ?: "$rootDir/servers"
    java7Home = project.findProperty('java7.home') ?: '/opt/jdk1.7.0_80'
    java8Home = project.findProperty('java8.home') ?: '/opt/jdk1.8.0_92'
}

teamcity {
    ...

    environments {
        downloadsDir = project.downloadsDir
        baseHomeDir = project.serversDir
        baseDataDir = 'data'

        teamcity9 {
            version = '9.1.7'
            javaHome = file(java7Home)
        }

        teamcity10 {
            version = '10.0.4'
            javaHome = file(java8Home)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This next example shows using a Groovy closure to create a string with the Java debug options with a different port
for each Java process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def debugOptions = { port -> "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${port}" }

teamcity {
    environments {
        teamcity9 {
            version = '9.1.7'
            javaHome = file(java7Home)
            serverOptions debugOptions(5005)
            agentOptions debugOptions(5006)
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using_environment_tasks">Using environment tasks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this next section we use the tasks available in each environment to deploy the plugin, start and stop both the
TeamCity Server and Build Agent.</p>
</div>
<div class="sect2">
<h3 id="deploying_the_plugin">Deploying the plugin</h3>
<div class="paragraph">
<p>The following steps use the <a href="https://github.com/rodm/gradle-teamcity-plugin/tree/master/samples/agent-server-plugin">agent-server-plugin</a> from the samples directory. The plugin is a simple
example of a Build Feature plugin that has both agent-side and server-side components.</p>
</div>
<div class="paragraph">
<p>If the TeamCity Server for the environment is not already installed the following task can be executed to download and
install the TeamCity Server. This task can take several minutes to complete.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew installTeamcity10</pre>
</div>
</div>
<div class="paragraph">
<p>We can now start the TeamCity Server by executing the following task.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew startTeamcity10Server</pre>
</div>
</div>
<div class="paragraph">
<p>The output from the task shows that starting the server will also deploy the plugin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>:build UP-TO-DATE
:deployPluginToTeamcity10
:startTeamcity10Server

BUILD SUCCESSFUL</pre>
</div>
</div>
<div class="paragraph">
<p>The first time the server is started some setup is required, accepting the license, selecting the database and
creating an administration user.</p>
</div>
<div class="paragraph">
<p>To see the deployed plugin navigate to the <a href="http://localhost:8111/admin/admin.html?item=plugins">Plugins List</a> in the TeamCity Administration
page. The external plugins should show the plugin as shown in the following image</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/teamcity-plugins-list.png" alt="TeamCity Plugins List">
</div>
</div>
<div class="paragraph">
<p>The plugin can be deployed or re-deployed with or with-out the server running by executing the deploy task, as shown.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew deployPluginToTeamcity10</pre>
</div>
</div>
<div class="paragraph">
<p>Finally to start the TeamCity Build Agent the following task can be run.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew startTeamcity10Agent</pre>
</div>
</div>
<div class="paragraph">
<p>After the TeamCity Build Agent has finished its startup procedures it will appear in the
<a href="http://localhost:8111/agents.html">Agents</a> list.</p>
</div>
</div>
<div class="sect2">
<h3 id="making_a_change_to_a_web_resource_and_re_deploying_the_plugin">Making a change to a web resource and re-deploying the plugin</h3>
<div class="paragraph">
<p>We can make a change to a web resource file, for example changing the file
<code>src/main/resources/buildServerResources/example.jsp</code> and then re-deploy the plugin without re-starting the server.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew deployPluginToTeamcity10</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>...
:check UP-TO-DATE
:build
:deployPluginToTeamcity10

BUILD SUCCESSFUL

Total time: 7.467 secs</pre>
</div>
</div>
<div class="paragraph">
<p>Refreshing the <a href="http://localhost:8111/example.html">example page</a> should show the change.</p>
</div>
<div class="paragraph">
<p>It takes quite a few seconds for Gradle to configure and execute the tasks required to re-package and
re-deploy the plugin. Gradle supports a continuous option that keeps Gradle running and monitoring the project
for any changes. We can run the deploy task with the continuous option.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew --continuous deployPluginToTeamcity10</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Continuous build is an incubating feature.
...
:build UP-TO-DATE
:deployPluginToTeamcity10 UP-TO-DATE

BUILD SUCCESSFUL

Total time: 6.836 secs

Waiting for changes to input files of tasks... (ctrl-d to exit)</pre>
</div>
</div>
<div class="paragraph">
<p>Running the task with the continuous option takes about the same amount of time as the previous deploy but when the
resource file is changed again, as shown below, it is much quicker to re-deploy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Waiting for changes to input files of tasks... (ctrl-d to exit)
modified: .../agent-server-plugin/src/main/resources/buildServerResources/example.jsp
Change detected, executing build...

...
:check UP-TO-DATE
:build
:deployPluginToTeamcity10

BUILD SUCCESSFUL

Total time: 1.648 secs

Waiting for changes to input files of tasks... (ctrl-d to exit)</pre>
</div>
</div>
<div class="paragraph">
<p>To run the build continuously from within IDEA requires editing a Run/Debug Configuration and providing the
'--continuous' option to a configuration the executes a 'deploy' task, as shown in the following image:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/gradle-run-settings.png" alt="IDEA Gradle Run Configuration">
</div>
</div>
</div>
<div class="sect2">
<h3 id="making_a_change_to_a_class">Making a change to a class</h3>
<div class="paragraph">
<p>We can make a change to a class but there are some restrictions. The TeamCity documentation,
<a href="https://confluence.jetbrains.com/display/TCD10/Development+Environment">Development Environment</a>, covers what can and can&#8217;t be done when changing a class.
To summarise, using a debug connection, only method bodies can be changed and updated using the JVM&#8217;s HotSwap feature.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debugging_the_plugin">Debugging the plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will go through the steps to setup both the TeamCity Server and Build Agent in debug mode
and connect a remote debugger to them using IntelliJ IDEA.</p>
</div>
<div class="paragraph">
<p>To debug the TeamCity Server and Build Agent requires enabling the debug options for each Java process. The following
example shows and environment with debug options for both the server and agent. Note each uses a different port, this
is required if both are to be debugged at the same time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    environments {
        teamcity10 {
            version = '10.0.4'
            javaHome = file(java8Home)
            serverOptions '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005'
            agentOptions '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5006'
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a Remote Run/Debug Configuration for both the server and the agent, as shown below, the port for each should
match the configuration shown above.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/remote-debug-settings.png" alt="IDEA Remote Run/Debug Settings">
</div>
</div>
<div class="paragraph">
<p>We should then have two Remote Debug configurations as shown below.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/remote-debug-configuration.png" alt="IDEA Remote Run/Debug Configurations">
</div>
</div>
<div class="paragraph">
<p>Start both the server and agent using the Gradle tasks, 'startTeamcity10Server' and 'startTeamcity10Agent', either
from the command line or using the Gradle Tool Window in IDEA.</p>
</div>
<div class="paragraph">
<p>We will need a project and a build configuration to test debugging the plugin. Once the server is started create a
project and then a build configuration. The build configuration doesn&#8217;t require a VCS root or a build file,
a command line build step using an inline script will do.</p>
</div>
<div class="paragraph">
<p>Start the Remote debug connection for the server. Open the 'ExampleBuildFeature' class in the main project and
set a breakpoint in the 'describeParameters' method. Using the TeamCity UI edit the build configuration and
add the 'Example Build Feature', the remote debug connection should stop at the breakpoint in the plugin source.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/breakpoint-server-side.png" alt="Server-side plugin breakpoint">
</div>
</div>
<div class="paragraph">
<p>The same can be done for agent-side plugin code, start the Remote debug connection for the agent. Open the
'ExampleBuildFeature' class in the agent sub-project and set a breakpoint in the 'buildStarted' method.
Run the build configuration, the remote debug connection for the agent should stop at the breakpoint in the
agent-side plugin source.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/blog/2016/12/breakpoint-agent-side.png" alt="Agent-side plugin breakpoint">
</div>
</div>
<div class="paragraph">
<p>Be aware that the Agent debug connection can become disconnected if the agent preforms an upgrade. This can happen
if the agent-side code is changed and the plugin re-deployed.</p>
</div>
<div class="paragraph">
<p>This post has hopefully provided some help on testing and debugging TeamCity plugins using the
<a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>.</p>
</div>
</div>
</div></p>
  			<a href="blog/2016/11/using-the-gradle-teamcity-plugin-part1.html"><h1>Using the Gradle TeamCity plugin - Part 1</h1></a>
  			<p>30 November 2016</p>
            <p>Tags: 
                <a href="/tags/gradle.html">gradle</a>
            
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/build.html">build</a>
            
                <a href="/tags/plugin.html">plugin</a>
            </p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://rodm.github.io/blog/2016/10/teamcity-plugin-development-with-gradle.html">previous post</a> provided a very brief introduction to using the
<a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>.
This is the first post of two on using the plugin and will expand on the plugin&#8217;s configuration properties and tasks,
introduce agent-side plugin and tools support and a few tips on using the plugin. The second post will cover how to
setup multiple TeamCity environments to test and debug a plugin.</p>
</div>
<div class="paragraph">
<p>The Gradle TeamCity plugin actually consists of 3 plugins and typically each is applied to a separate Gradle project
in a multi-project setup to build and package the corresponding component of a TeamCity plugin.</p>
</div>
<div class="paragraph">
<p>The server-side plugin, <code>com.github.rodm.teamcity-server</code> adds tasks and dependencies to a Gradle project to build a
server-side plugin archive. This plugin is required to produced the final plugin archive to be deployed to a TeamCity server.</p>
</div>
<div class="paragraph">
<p>The agent-side plugin, <code>com.github.rodm.teamcity-agent</code> adds tasks and dependencies to a Gradle project to build an
agent-side plugin archive.</p>
</div>
<div class="paragraph">
<p>The third plugin is the common plugin, <code>com.github.rodm.teamcity-common</code>, this plugin only adds a dependency to a
Gradle project to support creating a shared library for use by both the agent-side and server-side components.</p>
</div>
<div class="paragraph">
<p>We can configure the version of the API to be used by the plugins by setting the <code>version</code> property in the <code>teamcity</code>
configuration. By default it&#8217;s set to '9.0', it can be set to any release or snapshot version of TeamCity but I
would recommend setting the version using only the major and minor numbers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    version = '9.1'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can support changing the version at build time by using a Gradle property. Using a Gradle property to change the
API version to build against makes it easy to discover any incompatible API changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">ext {
    teamcityVersion = findProperty('teamcity.version') ?: '9.1'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the above configuration, building the plugin against a newer version of the API can be run by providing an
override to the <code>teamcity.version</code> property at the command line.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./gradlew -Pteamcity.version=10.0 clean build</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common_plugin">Common plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first plugin of the three is the common plugin. This plugin only adds the <code>common-api</code> dependency to a Gradle
project. The output of the project, a jar file, can then be packaged with both the agent-side and server-side plugins.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">apply plugin: 'java'
apply plugin: 'com.github.rodm.teamcity-common'

teamcity {
    version = teamcityVersion
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above shows the <code>version</code> property being set with the value of the extension property <code>teamcityVersion</code>,
this expects the extension property value to be inherited from the root project.</p>
</div>
<div class="paragraph">
<p>By default the jar file will contain the project version as part of its name. For a jar file that will be packaged
into a plugin archive file it may not be necessary to keep the version, we can remove the version from the jar name
by setting the version property of the <code>jar</code> task to an empty string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">jar {
    version = ''
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="agent_plugin">Agent plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next plugin is the agent-side plugin, it adds the dependency <code>agent-api</code> to a project and the following
tasks:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>generateAgentDescriptor</code></p>
</li>
<li>
<p><code>processAgentDescriptor</code></p>
</li>
<li>
<p><code>agentPlugin</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>generateAgentDescriptor</code> task will use the descriptor defined in the Gradle build file and generate an agent-side
plugin descriptor file in the build directory. The task is disabled if the descriptor is defined to use an external
file.</p>
</div>
<div class="paragraph">
<p>The <code>processAgentDescriptor</code> task will use the descriptor file defined in the Gradle build file. It will copy the
descriptor file to the build directory and replace any token in the file with the value defined in the build file.</p>
</div>
<div class="paragraph">
<p>The <code>agentPlugin</code> task packages the agent-side jar, any third-party libraries and plugin descriptor into an agent-side
plugin archive, a zip file. The agent-side plugin archive is added to the <code>plugin</code> configuration so that it can be
used as a dependency by a project building the server-side plugin.</p>
</div>
<div class="paragraph">
<p>In addition to adding the above tasks the plugin extends the <code>jar</code> task to output warnings if the Spring Bean
descriptor file references any classes that are not included in the agent-side jar file.</p>
</div>
<div class="paragraph">
<p>The example below shows the minimum configuration required to create an agent-side plugin descriptor. More descriptor
properties supported by the plugin can be found in the <a href="https://github.com/rodm/gradle-teamcity-plugin#examples-1">examples</a> of the README file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    agent {
        descriptor {
            pluginDeployment {
                useSeparateClassloader = true
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can include a shared jar built against the <code>common-api</code> from another Gradle project by adding it as a dependency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">dependencies {
    compile project(':common')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the agent-side plugin archive name is a based on the name of the root Gradle project with '-agent' and
the project version appended. We can change this by setting the <code>baseName</code> and <code>version</code> properties of the <code>agentPlugin</code>
task.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">agentPlugin {
    baseName = 'pluginName'
    version = ''
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can include additional jars, native libraries and scripts in the plugin archive. The files to be included can be
defined in one or more <code>files</code> <a href="https://docs.gradle.org/current/javadoc/org/gradle/api/file/CopySpec.html">CopySpec</a> configuration blocks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    agent {
        files {
            into('lib') {
                from('path/to/additional/jars')
            }
        }
        files {
            into('bin') {
                from('path/to/scripts')
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="a_tool_plugin">A Tool plugin</h3>
<div class="paragraph">
<p>The agent-side plugin can also produce a tool plugin. A tool plugin can be used to repackage an existing tool for
deployment to TeamCity. The tool is made available to build configurations as a parameter, the parameter is the path
to where the tool is installed on each build agent.</p>
</div>
<div class="paragraph">
<p>A minimal Gradle project to build a tool plugin can apply the agent-side and server-side plugins and use Gradle&#8217;s
dependency management to download the tool to be repackaged.</p>
</div>
<div class="paragraph">
<p>The samples directory for the <a href="https://github.com/rodm/gradle-teamcity-plugin">Gradle TeamCity plugin</a> contains an example project,
agent-tool-plugin, that shows Apache Maven 3.3.3 being repackaged as a tool. The <a href="https://github.com/rodm/gradle-teamcity-plugin/blob/master/samples/agent-tool-plugin/build.gradle">build file</a>
shows how the Maven archive is downloaded as a dependency, added to the plugin archive using the <code>files</code>
<a href="https://docs.gradle.org/current/javadoc/org/gradle/api/file/CopySpec.html">CopySpec</a> and how the <code>mvn</code> shell script is set to be executable.</p>
</div>
<div class="paragraph">
<p>Creating tool plugins is useful for deploying tools to all TeamCity build agents that are not available using
the native package manager on the build agent host.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server_plugin">Server plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The final plugin is the server-side plugin, it adds the dependency <code>server-api</code> to the project and the following
tasks:-</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>generateServerDescriptor</code></p>
</li>
<li>
<p><code>processServerDescriptor</code></p>
</li>
<li>
<p><code>serverPlugin</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>generateServerDescriptor</code> task will use the descriptor defined in the Gradle build file and generate an server-side
plugin descriptor file in the build directory. The task is disabled if the descriptor is defined to use an external
file.</p>
</div>
<div class="paragraph">
<p>The <code>processServerDescriptor</code> task will use the descriptor file defined in the Gradle build file. It will copy the
descriptor file to the build directory and replace any token in the file with the value defined in the build file.
An example is shown at the end of this post.</p>
</div>
<div class="paragraph">
<p>The <code>serverPlugin</code> task packages the server-side jar, any third-party libraries, the agent-side plugin archive and
plugin descriptor into a server-side plugin archive, a zip file.</p>
</div>
<div class="paragraph">
<p>A complete set of the descriptor properties supported by the server-side plugin can be found in the
<a href="https://github.com/rodm/gradle-teamcity-plugin#examples">examples</a> of the README file.</p>
</div>
<div class="paragraph">
<p>The server-side plugin, like the agent-side plugin, extends the <code>jar</code> to output warnings if the Spring Bean descriptor
file references classes that are not included in the server-side jar file.</p>
</div>
<div class="paragraph">
<p>To include a jar from another project that has been built against the <code>common-api</code> the same configuration
shown above for the agent-side plugin can be used.</p>
</div>
<div class="paragraph">
<p>To include the agent-side plugin archive, the output from a project building the agent-side plugin, can be added to
the <code>agent</code> configuration as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">dependencies {
    agent project(path: ':agent', configuration: 'plugin')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server-side plugin like the agent-side plugin can include additional files, jars or native libs, and scripts in
the archive using the <code>files</code> <a href="https://docs.gradle.org/current/javadoc/org/gradle/api/file/CopySpec.html">CopySpec</a> property. The example shown for the agent-side is the
same for the server-side.</p>
</div>
<div class="paragraph">
<p>The default name for the plugin archive is the name of the root Gradle project, this is typically defined in the
settings.gradle file, and the version property. We can change the name and remove the version from the archive name
by setting the following properties on the <code>serverPlugin</code> task.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">serverPlugin {
    baseName = 'pluginName'
    version = ''
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tokens to be replaced in the plugin descriptor XML file should follow Ant&#8217;s style for tokens, this means they
should start and end with the '@' character.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;teamcity-plugin xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:noNamespaceSchemaLocation="urn:schemas-jetbrains-com:teamcity-plugin-v1-xml"&gt;
    &lt;info&gt;
        &lt;name&gt;server-plugin&lt;/name&gt;
        &lt;display-name&gt;server-plugin&lt;/display-name&gt;
        &lt;version&gt;@VERSION@&lt;/version&gt;
        &lt;description&gt;TeamCity Example Server Plugin&lt;/description&gt;
        &lt;vendor&gt;
            &lt;name&gt;@VENDOR_NAME@&lt;/name&gt;
        &lt;/vendor&gt;
    &lt;/info&gt;
    &lt;deployment use-separate-classloader="true"/&gt;
&lt;/teamcity-plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To replace the tokens in the above file the server-side plugin can be configured, as shown below, to provide a map
of the tokens and values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    server {
        descriptor = file("${rootDir}/teamcity-plugin.xml")
        tokens VERSION: project.version, VENDOR_NAME: 'vendor'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This post has hopefully provided more detail and some tips on building TeamCity plugins using the
<a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>. The next post will show how to use the plugin to test and
debug a TeamCity plugin.</p>
</div>
</div>
</div></p>
  			<a href="blog/2016/10/teamcity-plugin-development-with-gradle.html"><h1>TeamCity Plugin Development with Gradle</h1></a>
  			<p>28 October 2016</p>
            <p>Tags: 
                <a href="/tags/gradle.html">gradle</a>
            
                <a href="/tags/teamcity.html">teamcity</a>
            
                <a href="/tags/plugin.html">plugin</a>
            </p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This post follows the steps in <a href="https://confluence.jetbrains.com/display/TCD10/Getting+Started+with+Plugin+Development">Getting Started with Plugin Development</a>
but uses <a href="https://gradle.org">Gradle</a> as the build tool with the <a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#step_1_set_up_the_environment">Step 1 - Set up the environment</a></li>
<li><a href="#step_2_generate_a_gradle_project">Step 2 - Generate a Gradle project</a>
<ul class="sectlevel2">
<li><a href="#view_the_project_structure">View the project structure</a></li>
</ul>
</li>
<li><a href="#step_3_edit_the_plugin_descriptor">Step 3 - Edit the plugin descriptor</a></li>
<li><a href="#step_4_create_the_plugin_sources">Step 4 - Create the plugin sources</a>
<ul class="sectlevel2">
<li><a href="#a_create_the_plugin_web_resources">A. Create the plugin web-resources</a></li>
<li><a href="#b_create_the_controller_and_obtain_the_path_to_the_jsp">B. Create the controller and obtain the path to the JSP</a></li>
<li><a href="#c_update_the_spring_bean_definition">C. Update the Spring bean definition</a></li>
</ul>
</li>
<li><a href="#step_5_build_the_plugin_with_gradle">Step 5 - Build the plugin with Gradle</a></li>
<li><a href="#step_6_install_the_plugin_to_teamcity">Step 6 - Install the plugin to TeamCity</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_1_set_up_the_environment">Step 1 - Set up the environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To develop a plugin for TeamCity, first set up a plugin development environment.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and install <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Oracle Java</a>. Java 1.8 is required for TeamCity 10.</p>
</li>
<li>
<p>Download and install a Java IDE that has Gradle integration</p>
</li>
<li>
<p>Download and install <a href="https://gradle.org/gradle-download">Gradle</a>. Follow the <a href="https://docs.gradle.org/current/userguide/installation.html">Gradle installation instructions</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A TeamCity installation is not needed at this point and will be downloaded and installed later using a task provided
by the <a href="https://plugins.gradle.org/plugin/com.github.rodm.teamcity-server">Gradle TeamCity plugin</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_2_generate_a_gradle_project">Step 2 - Generate a Gradle project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unlike Maven, Gradle doesn&#8217;t have archetype support so the initial project structure will be created using Gradle&#8217;s
init task and the plugin files will be manually created.</p>
</div>
<div class="paragraph">
<p>Create a directory called demoPlugin, change into the directory and execute the following command to create
a Gradle project</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$GRADLE_HOME/bin/gradle init</pre>
</div>
</div>
<div class="paragraph">
<p>Note: On Windows use the <code>gradle.bat</code> command</p>
</div>
<div class="sect2">
<h3 id="view_the_project_structure">View the project structure</h3>
<div class="paragraph">
<p>After the command finishes the directory contains the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>build.gradle</code> file containing a commented-out sample Java project</p>
</li>
<li>
<p>the <code>settings.gradle</code> file</p>
</li>
<li>
<p>the <code>gradlew</code> file to run Gradle on Linux and OS X</p>
</li>
<li>
<p>the <code>gradlew.bat</code> file to run Gradle on Windows</p>
</li>
<li>
<p>the <code>gradle</code> directory contains the Gradle wrapper used to run Gradle</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Open the project in an IDE</p>
</div>
<div class="paragraph">
<p>Edit the <code>build.gradle</code> file and replace the contents with the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">plugins {
  id 'java'
  id 'com.github.rodm.teamcity-server' version '0.9.1'
}

group = 'com.demoDomain.teamcity.demoPlugin'
version = '1.0-SNAPSHOT'

teamcity {
    version = '10.0'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contents of the <code>settings.gradle</code> file should set the project name as shown</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">rootProject.name = 'demoPlugin'</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_3_edit_the_plugin_descriptor">Step 3 - Edit the plugin descriptor</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Gradle plugin supports defining the plugin descriptor in a separate file or in the build file. For this example
the descriptor will be defined in the <code>build.gradle</code> file. Add the following 'server' configuration block containing
the plugin descriptor to the build file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    version = '10.0'

    server {
        descriptor {
            name = project.name
            displayName = 'Demo Plugin'
            version = project.version
            vendorName = 'Demo Vendor'
            description = 'Demo plugin description'
            useSeparateClassloader = false
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the inline descriptor allows the descriptor to use property values generated during the build such as a
version number or a build timestamp.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_4_create_the_plugin_sources">Step 4 - Create the plugin sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create the following directories for the Java source and plugin resources</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>src/main/java</code></p>
</li>
<li>
<p><code>src/main/resources/META-INF</code></p>
</li>
<li>
<p><code>src/main/resources/buildServerResources</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="a_create_the_plugin_web_resources">A. Create the plugin web-resources</h3>
<div class="paragraph">
<p>In the <code>buildServerResources</code> directory create the <code>Hello.jsp</code> file. Enter the contents as shown in the
<a href="https://confluence.jetbrains.com/display/TCD10/Getting+Started+with+Plugin+Development#GettingStartedwithPluginDevelopment-A.Createthepluginweb-resources">TeamCity documentation</a></p>
</div>
</div>
<div class="sect2">
<h3 id="b_create_the_controller_and_obtain_the_path_to_the_jsp">B. Create the controller and obtain the path to the JSP</h3>
<div class="paragraph">
<p>In the <code>src/main/java</code> directory create the sub-directories <code>com/demoDomain/teamcity/demoPlugin</code> then create the
<code>AppServer.java</code> file. Enter the contents as shown in the
<a href="https://confluence.jetbrains.com/display/TCD10/Getting+Started+with+Plugin+Development#GettingStartedwithPluginDevelopment-B.CreatethecontrollerandobtainthepathtotheJSP">TeamCity documentation</a></p>
</div>
</div>
<div class="sect2">
<h3 id="c_update_the_spring_bean_definition">C. Update the Spring bean definition</h3>
<div class="paragraph">
<p>In the <code>src/main/resources/META-INF</code> directory create the file <code>build-server-plugin-demo-plugin.xml</code> and enter the
contents as shown in the
<a href="https://confluence.jetbrains.com/display/TCD10/Getting+Started+with+Plugin+Development#GettingStartedwithPluginDevelopment-C.UpdatetheSpringbeandefinition">TeamCity documentation</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_5_build_the_plugin_with_gradle">Step 5 - Build the plugin with Gradle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the root of the project execute the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew build</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>build/distributions</code> directory will contain the <code>demoPlugin-1.0-SNAPSHOT.zip</code> file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_6_install_the_plugin_to_teamcity">Step 6 - Install the plugin to TeamCity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To install and start a TeamCity instance edit the <code>build.gradle</code> file adding an 'environments' configuration block
as shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">teamcity {
    server {
        descriptor {
            ...
        }

        environments {
            teamcity10 {
                version = '10.0.2'
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>./gradlew tasks</code> to see the new tasks available to download and install TeamCity, tasks to start and stop the
server and agent, and tasks to deploy and undeploy the plugin.</p>
</div>
<div class="paragraph">
<p>To download and install TeamCity for the environment, execute the following command, note this will take some time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew installTeamcity10</pre>
</div>
</div>
<div class="paragraph">
<p>To deploy the plugin and start the server execute the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew startTeamcity10Server</pre>
</div>
</div>
<div class="paragraph">
<p>The first time the TeamCity Server is started a database connection must be selected, the license agreement
accepted and an administrator account setup. Select 'Internal HSQLDB' for the database type.</p>
</div>
<div class="paragraph">
<p>The TeamCity Demo Plugin should appear in <a href="http://localhost:8111/admin/admin.html?item=plugins">Administration|Plugins List</a>.</p>
</div>
<div class="paragraph">
<p>The Hello World page is available via <a href="http://localhost:8111/demoPlugin.html" class="bare">http://localhost:8111/demoPlugin.html</a>.</p>
</div>
<div class="paragraph">
<p>Completed examples of the build files can be downloaded from the following links <a href="build.gradle">build.gradle</a> and
<a href="settings.gradle">settings.gradle</a></p>
</div>
</div>
</div></p>
	
	<hr />
	
	<p>Older posts are available in the <a href="archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; Rod MacKenzie 2016-2017 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.5.1</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/prettify.js"></script>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-85716859-1', 'auto');
        ga('send', 'pageview');

    </script>

  </body>
</html>